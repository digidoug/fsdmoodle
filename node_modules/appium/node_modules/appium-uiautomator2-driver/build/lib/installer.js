'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

/**
 * UI2_VER, SERVER_DOWNLOAD_SHA512, SERVER_TEST_DOWNLOAD_SHA512 should be updated for every appium-uiautomator2-server release.
 */
var UI2_VER = "v0.0.8";
var SERVER_DOWNLOAD_SHA512 = "187bcd2a62b4ba169aed6bfec32a03f11ca9bd6e254254a6fc8b980f31e50d0c7aba653636f48d7c873de58ba6084d5fa992493d34d939998498386e0ecd6be3";
var SERVER_TEST_DOWNLOAD_SHA512 = "66f27145f33009f6ccc0a85760522a107c4e48f0fd79dcebca75e5eb342b9aaf93226f9c2d2c57a2c82323e1a9e17617af864565bafb24bca8f6bcbfbe34b511";

var UI2_SERVER_DOWNLOAD = 'https://github.com/appium/appium-uiautomator2-server/releases/download' + ('/' + UI2_VER + '/appium-uiautomator2-server-' + UI2_VER + '.apk');
var UI2_SERVER_TEST_DOWNLOAD = 'https://github.com/appium/appium-uiautomator2-server/releases/download' + ('/' + UI2_VER + '/appium-uiautomator2-server-debug-androidTest.apk');
var UI2_DIR = _path2['default'].resolve(__dirname, "..", "..", "uiautomator2");
var UI2_SERVER_APK_PATH = _path2['default'].resolve(UI2_DIR, 'appium-uiautomator2-server-' + UI2_VER + '.apk');
var UI2_TEST_APK_PATH = _path2['default'].resolve(UI2_DIR, 'appium-uiautomator2-server-debug-androidTest.apk');

function setupUiAutomator2() {
  return _regeneratorRuntime.async(function setupUiAutomator2$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(hashCheck(UI2_SERVER_APK_PATH, SERVER_DOWNLOAD_SHA512));

      case 2:
        context$1$0.t0 = context$1$0.sent;

        if (!context$1$0.t0) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(hashCheck(UI2_TEST_APK_PATH, SERVER_TEST_DOWNLOAD_SHA512));

      case 6:
        context$1$0.t0 = context$1$0.sent;

      case 7:
        if (!context$1$0.t0) {
          context$1$0.next = 12;
          break;
        }

        _logger2['default'].info("UiAutomator2 apk exists and has correct hash, skipping download");
        return context$1$0.abrupt('return');

      case 12:
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(downloadUiAutomator2ServerApk());

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(serverExists());

      case 16:
        if (context$1$0.sent) {
          context$1$0.next = 18;
          break;
        }

        throw new Error("Something went wrong in setting up UiAutomator2");

      case 18:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function hashCheck(fileName, SHA512) {
  var buffer, fingerprint;
  return _regeneratorRuntime.async(function hashCheck$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(fileName));

      case 2:
        if (!context$1$0.sent) {
          context$1$0.next = 10;
          break;
        }

        buffer = require("fs").readFileSync(fileName);
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(sha512(buffer));

      case 6:
        fingerprint = context$1$0.sent;
        return context$1$0.abrupt('return', fingerprint === SHA512);

      case 10:
        return context$1$0.abrupt('return', false);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function downloadUiAutomator2ServerApk() {
  var serverApk, serverTestApk, serverFingerprint, serverTestFingerprint;
  return _regeneratorRuntime.async(function downloadUiAutomator2ServerApk$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(UI2_DIR));

      case 2:
        _logger2['default'].info('downloading UiAutomator2 Server APK ' + UI2_VER + ' : ' + UI2_SERVER_DOWNLOAD);
        _logger2['default'].info('downloading UiAutomator2 Server test APK ' + UI2_VER + ' : ' + UI2_SERVER_TEST_DOWNLOAD);
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ url: UI2_SERVER_DOWNLOAD, encoding: null }));

      case 6:
        serverApk = context$1$0.sent;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ url: UI2_SERVER_TEST_DOWNLOAD, encoding: null }));

      case 9:
        serverTestApk = context$1$0.sent;

        if (!(!serverApk instanceof Buffer)) {
          context$1$0.next = 12;
          break;
        }

        throw new Error(Object.prototype.toString.call(serverApk));

      case 12:
        if (!(!serverTestApk instanceof Buffer)) {
          context$1$0.next = 14;
          break;
        }

        throw new Error(Object.prototype.toString.call(serverTestApk));

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(sha512(serverApk));

      case 16:
        serverFingerprint = context$1$0.sent;
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(sha512(serverTestApk));

      case 19:
        serverTestFingerprint = context$1$0.sent;

        if (!(serverFingerprint !== SERVER_DOWNLOAD_SHA512)) {
          context$1$0.next = 24;
          break;
        }

        _logger2['default'].errorAndThrow('bad Server SHA512 fingerprint: ' + serverFingerprint);
        _logger2['default'].error("Stopping the installation");
        return context$1$0.abrupt('return');

      case 24:
        if (!(serverTestFingerprint !== SERVER_TEST_DOWNLOAD_SHA512)) {
          context$1$0.next = 28;
          break;
        }

        _logger2['default'].errorAndThrow('bad Server test SHA512 fingerprint: ' + serverTestFingerprint);
        _logger2['default'].error("Stopping the installation");
        return context$1$0.abrupt('return');

      case 28:
        context$1$0.next = 30;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(UI2_SERVER_APK_PATH, serverApk, { encoding: 'binary' }));

      case 30:
        context$1$0.next = 32;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(UI2_TEST_APK_PATH, serverTestApk, { encoding: 'binary' }));

      case 32:
        context$1$0.next = 34;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.chmod(UI2_SERVER_APK_PATH, 420));

      case 34:
        context$1$0.next = 36;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.chmod(UI2_TEST_APK_PATH, 420));

      case 36:

        _logger2['default'].info("UiAutomator2 Server APKs downloaded");

      case 37:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function sha512(buffer) {
  var hash;
  return _regeneratorRuntime.async(function sha512$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        hash = _crypto2['default'].createHash('sha512');
        return context$1$0.abrupt('return', hash.update(buffer).digest('hex'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function serverExists() {
  return _regeneratorRuntime.async(function serverExists$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(UI2_SERVER_APK_PATH));

      case 3:
        context$1$0.t0 = context$1$0.sent;

        if (!context$1$0.t0) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(UI2_TEST_APK_PATH));

      case 7:
        context$1$0.t0 = context$1$0.sent;

      case 8:
        return context$1$0.abrupt('return', context$1$0.t0);

      case 11:
        context$1$0.prev = 11;
        context$1$0.t1 = context$1$0['catch'](0);

        if (!(context$1$0.t1.code.indexOf("ENOENT") !== -1)) {
          context$1$0.next = 15;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 15:
        throw context$1$0.t1;

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 11]]);
}

exports.setupUiAutomator2 = setupUiAutomator2;
exports.serverExists = serverExists;
exports.UI2_SERVER_APK_PATH = UI2_SERVER_APK_PATH;
exports.UI2_TEST_APK_PATH = UI2_TEST_APK_PATH;
exports.UI2_VER = UI2_VER;
//# sourceMappingURL=data:application/json;base64,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R0FBWixZQUFZO1FBQUUsbUJBQW1CLEdBQW5CLG1CQUFtQjtRQUFFLGlCQUFpQixHQUFqQixpQkFBaUI7UUFBRSxPQUFPLEdBQVAsT0FBTyIsImZpbGUiOiJsaWJcXGluc3RhbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcclxuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcclxuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XHJcbmltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcclxuXHJcbi8qKlxyXG4gKiBVSTJfVkVSLCBTRVJWRVJfRE9XTkxPQURfU0hBNTEyLCBTRVJWRVJfVEVTVF9ET1dOTE9BRF9TSEE1MTIgc2hvdWxkIGJlIHVwZGF0ZWQgZm9yIGV2ZXJ5IGFwcGl1bS11aWF1dG9tYXRvcjItc2VydmVyIHJlbGVhc2UuXHJcbiAqL1xyXG5jb25zdCBVSTJfVkVSID0gXCJ2MC4wLjhcIjtcclxuY29uc3QgU0VSVkVSX0RPV05MT0FEX1NIQTUxMiA9IFwiMTg3YmNkMmE2MmI0YmExNjlhZWQ2YmZlYzMyYTAzZjExY2E5YmQ2ZTI1NDI1NGE2ZmM4Yjk4MGYzMWU1MGQwYzdhYmE2NTM2MzZmNDhkN2M4NzNkZTU4YmE2MDg0ZDVmYTk5MjQ5M2QzNGQ5Mzk5OTg0OTgzODZlMGVjZDZiZTNcIjtcclxuY29uc3QgU0VSVkVSX1RFU1RfRE9XTkxPQURfU0hBNTEyID0gXCI2NmYyNzE0NWYzMzAwOWY2Y2NjMGE4NTc2MDUyMmExMDdjNGU0OGYwZmQ3OWRjZWJjYTc1ZTVlYjM0MmI5YWFmOTMyMjZmOWMyZDJjNTdhMmM4MjMyM2UxYTllMTc2MTdhZjg2NDU2NWJhZmIyNGJjYThmNmJjYmZiZTM0YjUxMVwiO1xyXG5cclxuXHJcbmNvbnN0IFVJMl9TRVJWRVJfRE9XTkxPQUQgPSBgaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0tdWlhdXRvbWF0b3IyLXNlcnZlci9yZWxlYXNlcy9kb3dubG9hZGAgK1xyXG4gICAgYC8ke1VJMl9WRVJ9L2FwcGl1bS11aWF1dG9tYXRvcjItc2VydmVyLSR7VUkyX1ZFUn0uYXBrYDtcclxuY29uc3QgVUkyX1NFUlZFUl9URVNUX0RPV05MT0FEID0gYGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtLXVpYXV0b21hdG9yMi1zZXJ2ZXIvcmVsZWFzZXMvZG93bmxvYWRgICtcclxuICAgIGAvJHtVSTJfVkVSfS9hcHBpdW0tdWlhdXRvbWF0b3IyLXNlcnZlci1kZWJ1Zy1hbmRyb2lkVGVzdC5hcGtgO1xyXG5jb25zdCBVSTJfRElSID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgXCIuLlwiLCBcIi4uXCIsIFwidWlhdXRvbWF0b3IyXCIpO1xyXG5jb25zdCBVSTJfU0VSVkVSX0FQS19QQVRIID0gcGF0aC5yZXNvbHZlKFVJMl9ESVIsIGBhcHBpdW0tdWlhdXRvbWF0b3IyLXNlcnZlci0ke1VJMl9WRVJ9LmFwa2ApO1xyXG5jb25zdCBVSTJfVEVTVF9BUEtfUEFUSCA9IHBhdGgucmVzb2x2ZShVSTJfRElSLCBgYXBwaXVtLXVpYXV0b21hdG9yMi1zZXJ2ZXItZGVidWctYW5kcm9pZFRlc3QuYXBrYCk7XHJcblxyXG5cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIHNldHVwVWlBdXRvbWF0b3IyICgpIHtcclxuICBpZiAoYXdhaXQgaGFzaENoZWNrKFVJMl9TRVJWRVJfQVBLX1BBVEgsIFNFUlZFUl9ET1dOTE9BRF9TSEE1MTIpICYmIGF3YWl0IGhhc2hDaGVjayhVSTJfVEVTVF9BUEtfUEFUSCwgU0VSVkVSX1RFU1RfRE9XTkxPQURfU0hBNTEyKSkge1xyXG4gICAgbG9nLmluZm8oXCJVaUF1dG9tYXRvcjIgYXBrIGV4aXN0cyBhbmQgaGFzIGNvcnJlY3QgaGFzaCwgc2tpcHBpbmcgZG93bmxvYWRcIik7XHJcbiAgICByZXR1cm47XHJcbiAgfSBlbHNlIHtcclxuICAgIGF3YWl0IGRvd25sb2FkVWlBdXRvbWF0b3IyU2VydmVyQXBrKCk7XHJcbiAgfVxyXG5cclxuICBpZiAoIShhd2FpdCBzZXJ2ZXJFeGlzdHMoKSkpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihcIlNvbWV0aGluZyB3ZW50IHdyb25nIGluIHNldHRpbmcgdXAgVWlBdXRvbWF0b3IyXCIpO1xyXG4gIH1cclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gaGFzaENoZWNrIChmaWxlTmFtZSwgU0hBNTEyKSB7XHJcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhmaWxlTmFtZSkpIHtcclxuICAgIHZhciBidWZmZXIgPSByZXF1aXJlKFwiZnNcIikucmVhZEZpbGVTeW5jKGZpbGVOYW1lKTtcclxuICAgIGxldCBmaW5nZXJwcmludCA9ICBhd2FpdCBzaGE1MTIoYnVmZmVyKTtcclxuICAgIHJldHVybiBmaW5nZXJwcmludCA9PT0gU0hBNTEyO1xyXG4gIH0gZWxzZSB7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBkb3dubG9hZFVpQXV0b21hdG9yMlNlcnZlckFwayAoKSB7XHJcblxyXG4gIGF3YWl0IGZzLm1rZGlyKFVJMl9ESVIpO1xyXG4gIGxvZy5pbmZvKGBkb3dubG9hZGluZyBVaUF1dG9tYXRvcjIgU2VydmVyIEFQSyAke1VJMl9WRVJ9IDogJHtVSTJfU0VSVkVSX0RPV05MT0FEfWApO1xyXG4gIGxvZy5pbmZvKGBkb3dubG9hZGluZyBVaUF1dG9tYXRvcjIgU2VydmVyIHRlc3QgQVBLICR7VUkyX1ZFUn0gOiAke1VJMl9TRVJWRVJfVEVTVF9ET1dOTE9BRH1gKTtcclxuICBsZXQgc2VydmVyQXBrID0gYXdhaXQgcmVxdWVzdC5nZXQoe3VybDogVUkyX1NFUlZFUl9ET1dOTE9BRCwgZW5jb2Rpbmc6IG51bGx9KTtcclxuICBsZXQgc2VydmVyVGVzdEFwayA9IGF3YWl0IHJlcXVlc3QuZ2V0KHt1cmw6IFVJMl9TRVJWRVJfVEVTVF9ET1dOTE9BRCwgZW5jb2Rpbmc6IG51bGx9KTtcclxuICBpZiAoIXNlcnZlckFwayBpbnN0YW5jZW9mIEJ1ZmZlciApIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoc2VydmVyQXBrKSk7XHJcbiAgfVxyXG4gIGlmICghc2VydmVyVGVzdEFwayBpbnN0YW5jZW9mIEJ1ZmZlciApIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoc2VydmVyVGVzdEFwaykpO1xyXG4gIH1cclxuICBsZXQgc2VydmVyRmluZ2VycHJpbnQgPSBhd2FpdCBzaGE1MTIoc2VydmVyQXBrKTtcclxuICBsZXQgc2VydmVyVGVzdEZpbmdlcnByaW50ID0gYXdhaXQgc2hhNTEyKHNlcnZlclRlc3RBcGspO1xyXG5cclxuICBpZiAoIHNlcnZlckZpbmdlcnByaW50ICE9PSBTRVJWRVJfRE9XTkxPQURfU0hBNTEyICkge1xyXG4gICAgbG9nLmVycm9yQW5kVGhyb3coYGJhZCBTZXJ2ZXIgU0hBNTEyIGZpbmdlcnByaW50OiAke3NlcnZlckZpbmdlcnByaW50fWApO1xyXG4gICAgbG9nLmVycm9yKFwiU3RvcHBpbmcgdGhlIGluc3RhbGxhdGlvblwiICk7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG4gIGlmICggc2VydmVyVGVzdEZpbmdlcnByaW50ICE9PSBTRVJWRVJfVEVTVF9ET1dOTE9BRF9TSEE1MTIgKXtcclxuICAgIGxvZy5lcnJvckFuZFRocm93KGBiYWQgU2VydmVyIHRlc3QgU0hBNTEyIGZpbmdlcnByaW50OiAke3NlcnZlclRlc3RGaW5nZXJwcmludH1gKTtcclxuICAgIGxvZy5lcnJvcihcIlN0b3BwaW5nIHRoZSBpbnN0YWxsYXRpb25cIik7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG4gIGF3YWl0IGZzLndyaXRlRmlsZShVSTJfU0VSVkVSX0FQS19QQVRILCBzZXJ2ZXJBcGssIHtlbmNvZGluZzogJ2JpbmFyeSd9KTtcclxuICBhd2FpdCBmcy53cml0ZUZpbGUoVUkyX1RFU1RfQVBLX1BBVEgsIHNlcnZlclRlc3RBcGssIHtlbmNvZGluZzogJ2JpbmFyeSd9KTtcclxuXHJcbiAgYXdhaXQgZnMuY2htb2QoVUkyX1NFUlZFUl9BUEtfUEFUSCwgMG8wNjQ0KTtcclxuICBhd2FpdCBmcy5jaG1vZChVSTJfVEVTVF9BUEtfUEFUSCwgMG8wNjQ0KTtcclxuXHJcbiAgbG9nLmluZm8oXCJVaUF1dG9tYXRvcjIgU2VydmVyIEFQS3MgZG93bmxvYWRlZFwiKTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gc2hhNTEyIChidWZmZXIpIHtcclxuICBjb25zdCBoYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTUxMicpO1xyXG4gIHJldHVybiBoYXNoLnVwZGF0ZShidWZmZXIpLmRpZ2VzdCgnaGV4Jyk7XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIHNlcnZlckV4aXN0cyAoKSB7XHJcbiAgdHJ5IHtcclxuICAgIHJldHVybiAoYXdhaXQgZnMuZXhpc3RzKFVJMl9TRVJWRVJfQVBLX1BBVEgpICYmXHJcbiAgICBhd2FpdCBmcy5leGlzdHMoVUkyX1RFU1RfQVBLX1BBVEgpKTtcclxuICB9IGNhdGNoIChlKSB7XHJcbiAgICBpZiAoZS5jb2RlLmluZGV4T2YoXCJFTk9FTlRcIikgIT09IC0xKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIHRocm93IGU7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBzZXR1cFVpQXV0b21hdG9yMiwgc2VydmVyRXhpc3RzLCBVSTJfU0VSVkVSX0FQS19QQVRILCBVSTJfVEVTVF9BUEtfUEFUSCwgVUkyX1ZFUiB9O1xyXG4iXX0=
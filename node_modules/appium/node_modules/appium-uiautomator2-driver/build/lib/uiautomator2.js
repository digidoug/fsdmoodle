'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _teen_process = require('teen_process');

var _appiumBaseDriver = require('appium-base-driver');

var _asyncbox = require('asyncbox');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _installer = require('./installer');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var REQD_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort'];

var adbkit = require('adbkit');
var client = adbkit.createClient();

var UiAutomator2Server = (function () {
  function UiAutomator2Server() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, UiAutomator2Server);

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = _getIterator(REQD_PARAMS), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var req = _step.value;

        if (!opts || !opts[req]) {
          throw new Error('Option \'' + req + '\' is required!');
        }
        this[req] = opts[req];
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({ host: this.host, port: this.systemPort });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
  }

  _createClass(UiAutomator2Server, [{
    key: 'installServerApk',
    value: function installServerApk() {
      var apkPackage, testApkPackage, isApkInstalled, isTestApkInstalled, apkVersion, pkgVersion;
      return _regeneratorRuntime.async(function installServerApk$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getPackageName(_installer.UI2_SERVER_APK_PATH));

          case 2:
            apkPackage = context$2$0.sent;
            testApkPackage = apkPackage + '.test';
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.adb.isAppInstalled(apkPackage));

          case 6:
            isApkInstalled = context$2$0.sent;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.adb.isAppInstalled(testApkPackage));

          case 9:
            isTestApkInstalled = context$2$0.sent;

            if (!(isApkInstalled || isTestApkInstalled)) {
              context$2$0.next = 24;
              break;
            }

            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.getAPKVersion(_installer.UI2_SERVER_APK_PATH));

          case 13:
            apkVersion = context$2$0.sent;
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(this.getInstalledPackageVersion(apkPackage));

          case 16:
            pkgVersion = context$2$0.sent;

            if (!(apkVersion !== pkgVersion)) {
              context$2$0.next = 24;
              break;
            }

            isApkInstalled = false;
            isTestApkInstalled = false;
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(this.adb.uninstallApk(apkPackage));

          case 22:
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(this.adb.uninstallApk(testApkPackage));

          case 24:
            if (isApkInstalled) {
              context$2$0.next = 27;
              break;
            }

            context$2$0.next = 27;
            return _regeneratorRuntime.awrap(this.signAndInstall(_installer.UI2_SERVER_APK_PATH, apkPackage));

          case 27:
            if (isTestApkInstalled) {
              context$2$0.next = 30;
              break;
            }

            context$2$0.next = 30;
            return _regeneratorRuntime.awrap(this.signAndInstall(_installer.UI2_TEST_APK_PATH, testApkPackage));

          case 30:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'signAndInstall',
    value: function signAndInstall(apk, apkPackage) {
      return _regeneratorRuntime.async(function signAndInstall$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.checkAndSignCert(apk, apkPackage));

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.adb.install(apk));

          case 4:
            _logger2['default'].info("Installed UiAutomator2 server apk");

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getPackageName',
    value: function getPackageName(apk) {
      var args, _ref, stdout, apkPackage;

      return _regeneratorRuntime.async(function getPackageName$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            args = ['dump', 'badging', apk];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.adb.initAapt());

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.adb.binaries.aapt, args));

          case 5:
            _ref = context$2$0.sent;
            stdout = _ref.stdout;
            apkPackage = new RegExp(/package: name='([^']+)'/g).exec(stdout);

            if (apkPackage && apkPackage.length >= 2) {
              apkPackage = apkPackage[1];
            } else {
              apkPackage = null;
            }
            return context$2$0.abrupt('return', apkPackage);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getAPKVersion',
    value: function getAPKVersion(apk) {
      var args, _ref2, stdout, apkVersion;

      return _regeneratorRuntime.async(function getAPKVersion$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            args = ['dump', 'badging', apk];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.adb.initAapt());

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.adb.binaries.aapt, args));

          case 5:
            _ref2 = context$2$0.sent;
            stdout = _ref2.stdout;
            apkVersion = new RegExp(/versionName='([^']+)'/g).exec(stdout);

            if (apkVersion && apkVersion.length >= 2) {
              apkVersion = apkVersion[1];
            } else {
              apkVersion = null;
            }
            return context$2$0.abrupt('return', apkVersion.toString());

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getInstalledPackageVersion',
    value: function getInstalledPackageVersion(pkg) {
      var stdout, pkgVersion;
      return _regeneratorRuntime.async(function getInstalledPackageVersion$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.adb.shell(['dumpsys', 'package', pkg]));

          case 2:
            stdout = context$2$0.sent;
            pkgVersion = new RegExp(/versionName=([^\s\s]+)/g).exec(stdout);

            if (pkgVersion && pkgVersion.length >= 2) {
              pkgVersion = pkgVersion[1];
            } else {
              pkgVersion = null;
            }
            return context$2$0.abrupt('return', pkgVersion.toString());

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'checkAndSignCert',
    value: function checkAndSignCert(apk, apkPackage) {
      var signed;
      return _regeneratorRuntime.async(function checkAndSignCert$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.adb.checkApkCert(apk, apkPackage));

          case 2:
            signed = context$2$0.sent;

            if (signed) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.adb.sign(apk));

          case 6:
            return context$2$0.abrupt('return', !signed);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSession',
    value: function startSession(caps) {
      var cmd;
      return _regeneratorRuntime.async(function startSession$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmd = ['am', 'instrument', '-w', 'io.appium.uiautomator2.server.test/android.support.test.runner.AndroidJUnitRunner'];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.killUiAutomatorOnDevice());

          case 3:

            _logger2['default'].info('Starting uiautomator2 server ' + _installer.UI2_VER + ' with cmd: ' + ('' + cmd));
            //this.adb.shell(cmd);
            //using 3rd party module called 'adbKit' for time being as using 'appium-adb'
            //facing IllegalStateException: UiAutomation not connected exception
            //https://github.com/appium/appium-uiautomator2-driver/issues/19

            if (caps.deviceUDID) {
              this.startSessionOnSpecificDeviceUsingAdbKit(caps.deviceUDID);
            } else {
              this.startSessionUsingAdbkit();
            }

            _logger2['default'].info('Waiting for UiAutomator2 to be online...');
            // wait 20s for UiAutomator2 to be online
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(20, 1000, function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.jwproxy.command('/status', 'GET'));

                  case 2:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            }));

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/session', 'POST', { desiredCapabilities: caps }));

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSessionOnSpecificDeviceUsingAdbKit',
    value: function startSessionOnSpecificDeviceUsingAdbKit(deviceUDID) {
      return _regeneratorRuntime.async(function startSessionOnSpecificDeviceUsingAdbKit$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _bluebird2['default']['try'](function () {
              _logger2['default'].info('running command...\n adb -s ' + deviceUDID + ' shell am instrument -w io.appium.uiautomator2.server.test/android.support.test.runner.AndroidJUnitRunner... ');
              client.shell(deviceUDID, "am instrument -w io.appium.uiautomator2.server.test/android.support.test.runner.AndroidJUnitRunner");
            })['catch'](function (err) {
              _logger2['default'].error('Something went wrong while executing instrument test:', err.stack);
            });

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSessionUsingAdbkit',
    value: function startSessionUsingAdbkit() {
      return _regeneratorRuntime.async(function startSessionUsingAdbkit$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            client.listDevices().then(function (devices) {
              _bluebird2['default'].map(devices, function (device) {
                _logger2['default'].info("running command...\n adb shell am instrument -w io.appium.uiautomator2.server.test/android.support.test.runner.AndroidJUnitRunner... ");
                client.shell(device.id, "am instrument -w io.appium.uiautomator2.server.test/android.support.test.runner.AndroidJUnitRunner");
              });
            })['catch'](function (err) {
              _logger2['default'].error('Something went wrong while executing instrument test:', err.stack);
            });

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Deleting UiAutomator2 server session');
            // rely on jwproxy's intelligence to know what we're talking about and
            // delete the current session
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/', 'DELETE'));

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].warn('Did not get confirmation UiAutomator2 deleteSession worked; ' + ('Error was: ' + context$2$0.t0));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }, {
    key: 'killUiAutomatorOnDevice',
    value: function killUiAutomatorOnDevice() {
      return _regeneratorRuntime.async(function killUiAutomatorOnDevice$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.adb.killProcessesByName('io.appium.uiautomator2.server'));

          case 3:
            context$2$0.next = 8;
            break;

          case 5:
            context$2$0.prev = 5;
            context$2$0.t0 = context$2$0['catch'](0);

            _logger2['default'].info("Unable to kill the io.appium.uiautomator2.server process, assuming it is already killed");

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 5]]);
    }
  }]);

  return UiAutomator2Server;
})();

exports['default'] = UiAutomator2Server;
module.exports = exports['default'];

// Installs the apks on to the device or emulator

// appending .test to apkPackage name to get test apk package name

//check server apk versionName

// killing any uiautomator existing processes
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYlxcdWlhdXRvbWF0b3IyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7NEJBQXFCLGNBQWM7O2dDQUNYLG9CQUFvQjs7d0JBQ2QsVUFBVTs7c0JBQ3JCLFVBQVU7Ozs7eUJBQzRELGFBQWE7O3dCQUNsRixVQUFVOzs7O0FBRTlCLElBQU0sV0FBVyxHQUFHLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLFlBQVksQ0FBQyxDQUFDOztBQUUxRSxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDL0IsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDOztJQUU3QixrQkFBa0I7QUFDVixXQURSLGtCQUFrQixHQUNFO1FBQVgsSUFBSSx5REFBRyxFQUFFOzswQkFEbEIsa0JBQWtCOzs7Ozs7O0FBRXBCLHdDQUFnQixXQUFXLDRHQUFFO1lBQXBCLEdBQUc7O0FBQ1YsWUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtBQUN2QixnQkFBTSxJQUFJLEtBQUssZUFBWSxHQUFHLHFCQUFpQixDQUFDO1NBQ2pEO0FBQ0QsWUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztPQUN2Qjs7Ozs7Ozs7Ozs7Ozs7OztBQUNELFFBQUksQ0FBQyxPQUFPLEdBQUcsOEJBQVksRUFBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBQyxDQUFDLENBQUM7QUFDckUsUUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0dBQ2hFOztlQVZHLGtCQUFrQjs7V0FZQztVQUVqQixVQUFVLEVBRVYsY0FBYyxFQUNkLGNBQWMsRUFDZCxrQkFB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LENBQUMsQ0FBQzs7Ozs7NkNBSTdDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUM7Ozs7Ozs7Ozs7QUFFekMsZ0NBQU8sSUFBSSxDQUFDLGlHQUNXLENBQUMsQ0FBQzs7Ozs7OztLQUU1Qjs7O1dBRTZCOzs7Ozs7NkNBRXBCLElBQUksQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsK0JBQStCLENBQUM7Ozs7Ozs7Ozs7QUFFbkUsZ0NBQU8sSUFBSSxDQUFDLHlGQUF5RixDQUFDLENBQUM7Ozs7Ozs7S0FFMUc7OztTQTlKRyxrQkFBa0I7OztxQkFpS1Qsa0JBQWtCIiwiZmlsZSI6ImxpYlxcdWlhdXRvbWF0b3IyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XHJcbmltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xyXG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xyXG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcclxuaW1wb3J0IHsgVUkyX1NFUlZFUl9BUEtfUEFUSCBhcyBhcGtQYXRoLCBVSTJfVEVTVF9BUEtfUEFUSCBhcyB0ZXN0QXBrUGF0aCwgVUkyX1ZFUn0gZnJvbSAnLi9pbnN0YWxsZXInO1xyXG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XHJcblxyXG5jb25zdCBSRVFEX1BBUkFNUyA9IFsnYWRiJywgJ3RtcERpcicsICdob3N0JywgJ3N5c3RlbVBvcnQnLCAnZGV2aWNlUG9ydCddO1xyXG5cclxudmFyIGFkYmtpdCA9IHJlcXVpcmUoJ2FkYmtpdCcpO1xyXG52YXIgY2xpZW50ID0gYWRia2l0LmNyZWF0ZUNsaWVudCgpO1xyXG5cclxuY2xhc3MgVWlBdXRvbWF0b3IyU2VydmVyIHtcclxuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XHJcbiAgICBmb3IgKGxldCByZXEgb2YgUkVRRF9QQVJBTVMpIHtcclxuICAgICAgaWYgKCFvcHRzIHx8ICFvcHRzW3JlcV0pIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE9wdGlvbiAnJHtyZXF9JyBpcyByZXF1aXJlZCFgKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzW3JlcV0gPSBvcHRzW3JlcV07XHJcbiAgICB9XHJcbiAgICB0aGlzLmp3cHJveHkgPSBuZXcgSldQcm94eSh7aG9zdDogdGhpcy5ob3N0LCBwb3J0OiB0aGlzLnN5c3RlbVBvcnR9KTtcclxuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgaW5zdGFsbFNlcnZlckFwayAoKSB7XHJcbiAgICAvLyBJbnN0YWxscyB0aGUgYXBrcyBvbiB0byB0aGUgZGV2aWNlIG9yIGVtdWxhdG9yXHJcbiAgICBsZXQgYXBrUGFja2FnZSA9IGF3YWl0IHRoaXMuZ2V0UGFja2FnZU5hbWUoYXBrUGF0aCk7XHJcbiAgICAvLyBhcHBlbmRpbmcgLnRlc3QgdG8gYXBrUGFja2FnZSBuYW1lIHRvIGdldCB0ZXN0IGFwayBwYWNrYWdlIG5hbWVcclxuICAgIGxldCB0ZXN0QXBrUGFja2FnZSA9IGFwa1BhY2thZ2UgKyAnLnRlc3QnO1xyXG4gICAgbGV0IGlzQXBrSW5zdGFsbGVkID0gYXdhaXQgdGhpcy5hZGIuaXNBcHBJbnN0YWxsZWQoYXBrUGFja2FnZSk7XHJcbiAgICBsZXQgaXNUZXN0QXBrSW5zdGFsbGVkID0gYXdhaXQgdGhpcy5hZGIuaXNBcHBJbnN0YWxsZWQodGVzdEFwa1BhY2thZ2UpO1xyXG4gICAgaWYgKGlzQXBrSW5zdGFsbGVkIHx8IGlzVGVzdEFwa0luc3RhbGxlZCkge1xyXG4gICAgICAvL2NoZWNrIHNlcnZlciBhcGsgdmVyc2lvbk5hbWVcclxuICAgICAgbGV0IGFwa1ZlcnNpb24gPSBhd2FpdCB0aGlzLmdldEFQS1ZlcnNpb24oYXBrUGF0aCk7XHJcbiAgICAgIGxldCBwa2dWZXJzaW9uID0gYXdhaXQgdGhpcy5nZXRJbnN0YWxsZWRQYWNrYWdlVmVyc2lvbihhcGtQYWNrYWdlKTtcclxuICAgICAgaWYgKGFwa1ZlcnNpb24gIT09IHBrZ1ZlcnNpb24pIHtcclxuICAgICAgICBpc0Fwa0luc3RhbGxlZCA9IGZhbHNlO1xyXG4gICAgICAgIGlzVGVzdEFwa0luc3RhbGxlZCA9IGZhbHNlO1xyXG4gICAgICAgIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayhhcGtQYWNrYWdlKTtcclxuICAgICAgICBhd2FpdCB0aGlzLmFkYi51bmluc3RhbGxBcGsodGVzdEFwa1BhY2thZ2UpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAoIWlzQXBrSW5zdGFsbGVkKSB7XHJcbiAgICAgIGF3YWl0IHRoaXMuc2lnbkFuZEluc3RhbGwoYXBrUGF0aCwgYXBrUGFja2FnZSk7XHJcbiAgICB9XHJcbiAgICBpZiAoIWlzVGVzdEFwa0luc3RhbGxlZCkge1xyXG4gICAgICBhd2FpdCB0aGlzLnNpZ25BbmRJbnN0YWxsKHRlc3RBcGtQYXRoLCB0ZXN0QXBrUGFja2FnZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBzaWduQW5kSW5zdGFsbCAoYXBrLCBhcGtQYWNrYWdlKSB7XHJcbiAgICBhd2FpdCB0aGlzLmNoZWNrQW5kU2lnbkNlcnQoYXBrLCBhcGtQYWNrYWdlKTtcclxuICAgIGF3YWl0IHRoaXMuYWRiLmluc3RhbGwoYXBrKTtcclxuICAgIGxvZ2dlci5pbmZvKFwiSW5zdGFsbGVkIFVpQXV0b21hdG9yMiBzZXJ2ZXIgYXBrXCIpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0UGFja2FnZU5hbWUgKGFwaykge1xyXG4gICAgbGV0IGFyZ3MgPSBbJ2R1bXAnLCAnYmFkZ2luZycsIGFwa107XHJcbiAgICBhd2FpdCB0aGlzLmFkYi5pbml0QWFwdCgpO1xyXG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyh0aGlzLmFkYi5iaW5hcmllcy5hYXB0LCBhcmdzKTtcclxuICAgIGxldCBhcGtQYWNrYWdlID0gbmV3IFJlZ0V4cCgvcGFja2FnZTogbmFtZT0nKFteJ10rKScvZykuZXhlYyhzdGRvdXQpO1xyXG4gICAgaWYgKGFwa1BhY2thZ2UgJiYgYXBrUGFja2FnZS5sZW5ndGggPj0gMikge1xyXG4gICAgICBhcGtQYWNrYWdlID0gYXBrUGFja2FnZVsxXTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGFwa1BhY2thZ2UgPSBudWxsO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGFwa1BhY2thZ2U7XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRBUEtWZXJzaW9uIChhcGspIHtcclxuICAgIGxldCBhcmdzID0gWydkdW1wJywgJ2JhZGdpbmcnLCBhcGtdO1xyXG4gICAgYXdhaXQgdGhpcy5hZGIuaW5pdEFhcHQoKTtcclxuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWModGhpcy5hZGIuYmluYXJpZXMuYWFwdCwgYXJncyk7XHJcbiAgICBsZXQgYXBrVmVyc2lvbiA9IG5ldyBSZWdFeHAoL3ZlcnNpb25OYW1lPScoW14nXSspJy9nKS5leGVjKHN0ZG91dCk7XHJcbiAgICBpZiAoYXBrVmVyc2lvbiAmJiBhcGtWZXJzaW9uLmxlbmd0aCA+PSAyKSB7XHJcbiAgICAgIGFwa1ZlcnNpb24gPSBhcGtWZXJzaW9uWzFdO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgYXBrVmVyc2lvbiA9IG51bGw7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYXBrVmVyc2lvbi50b1N0cmluZygpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0SW5zdGFsbGVkUGFja2FnZVZlcnNpb24gKHBrZykge1xyXG4gICAgbGV0IHN0ZG91dCA9ICBhd2FpdCB0aGlzLmFkYi5zaGVsbChbJ2R1bXBzeXMnLCAncGFja2FnZScsIHBrZ10pO1xyXG4gICAgbGV0IHBrZ1ZlcnNpb24gPSBuZXcgUmVnRXhwKC92ZXJzaW9uTmFtZT0oW15cXHNcXHNdKykvZykuZXhlYyhzdGRvdXQpO1xyXG4gICAgaWYgKHBrZ1ZlcnNpb24gJiYgcGtnVmVyc2lvbi5sZW5ndGggPj0gMikge1xyXG4gICAgICBwa2dWZXJzaW9uID0gcGtnVmVyc2lvblsxXTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHBrZ1ZlcnNpb24gPSBudWxsO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHBrZ1ZlcnNpb24udG9TdHJpbmcoKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGNoZWNrQW5kU2lnbkNlcnQgKGFwaywgYXBrUGFja2FnZSkge1xyXG4gICAgbGV0IHNpZ25lZCA9IGF3YWl0IHRoaXMuYWRiLmNoZWNrQXBrQ2VydChhcGssIGFwa1BhY2thZ2UpO1xyXG4gICAgaWYgKCFzaWduZWQpIHtcclxuICAgICAgYXdhaXQgdGhpcy5hZGIuc2lnbihhcGspO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuICFzaWduZWQ7XHJcbiAgfVxyXG5cclxuICBhc3luYyBzdGFydFNlc3Npb24gKGNhcHMpIHtcclxuICAgIGxldCBjbWQgPSBbJ2FtJywgJ2luc3RydW1lbnQnLCAnLXcnLFxyXG4gICAgICAnaW8uYXBwaXVtLnVpYXV0b21hdG9yMi5zZXJ2ZXIudGVzdC9hbmRyb2lkLnN1cHBvcnQudGVzdC5ydW5uZXIuQW5kcm9pZEpVbml0UnVubmVyJ107XHJcblxyXG4gICAgLy8ga2lsbGluZyBhbnkgdWlhdXRvbWF0b3IgZXhpc3RpbmcgcHJvY2Vzc2VzXHJcbiAgICBhd2FpdCB0aGlzLmtpbGxVaUF1dG9tYXRvck9uRGV2aWNlKCk7XHJcblxyXG4gICAgbG9nZ2VyLmluZm8oYFN0YXJ0aW5nIHVpYXV0b21hdG9yMiBzZXJ2ZXIgJHtVSTJfVkVSfSB3aXRoIGNtZDogYCArXHJcbiAgICAgICAgYCR7Y21kfWApO1xyXG4gICAgLy90aGlzLmFkYi5zaGVsbChjbWQpO1xyXG4gICAgLy91c2luZyAzcmQgcGFydHkgbW9kdWxlIGNhbGxlZCAnYWRiS2l0JyBmb3IgdGltZSBiZWluZyBhcyB1c2luZyAnYXBwaXVtLWFkYidcclxuICAgIC8vZmFjaW5nIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbjogVWlBdXRvbWF0aW9uIG5vdCBjb25uZWN0ZWQgZXhjZXB0aW9uXHJcbiAgICAvL2h0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtLXVpYXV0b21hdG9yMi1kcml2ZXIvaXNzdWVzLzE5XHJcblxyXG4gICAgaWYgKGNhcHMuZGV2aWNlVURJRCkge1xyXG4gICAgICB0aGlzLnN0YXJ0U2Vzc2lvbk9uU3BlY2lmaWNEZXZpY2VVc2luZ0FkYktpdChjYXBzLmRldmljZVVESUQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5zdGFydFNlc3Npb25Vc2luZ0FkYmtpdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdXYWl0aW5nIGZvciBVaUF1dG9tYXRvcjIgdG8gYmUgb25saW5lLi4uJyk7XHJcbiAgICAvLyB3YWl0IDIwcyBmb3IgVWlBdXRvbWF0b3IyIHRvIGJlIG9ubGluZVxyXG4gICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgyMCwgMTAwMCwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcclxuICAgIH0pO1xyXG4gICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCB7ZGVzaXJlZENhcGFiaWxpdGllczogY2Fwc30pO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgc3RhcnRTZXNzaW9uT25TcGVjaWZpY0RldmljZVVzaW5nQWRiS2l0IChkZXZpY2VVRElEKSB7XHJcbiAgICBQcm9taXNlLnRyeShmdW5jdGlvbiAoKXtcclxuICAgICAgbG9nZ2VyLmluZm8oYHJ1bm5pbmcgY29tbWFuZC4uLlxcbiBhZGIgLXMgJHtkZXZpY2VVRElEfSBzaGVsbCBhbSBpbnN0cnVtZW50IC13IGlvLmFwcGl1bS51aWF1dG9tYXRvcjIuc2VydmVyLnRlc3QvYW5kcm9pZC5zdXBwb3J0LnRlc3QucnVubmVyLkFuZHJvaWRKVW5pdFJ1bm5lci4uLiBgKTtcclxuICAgICAgY2xpZW50LnNoZWxsKGRldmljZVVESUQsIFwiYW0gaW5zdHJ1bWVudCAtdyBpby5hcHBpdW0udWlhdXRvbWF0b3IyLnNlcnZlci50ZXN0L2FuZHJvaWQuc3VwcG9ydC50ZXN0LnJ1bm5lci5BbmRyb2lkSlVuaXRSdW5uZXJcIik7XHJcbiAgICB9KVxyXG4gICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcignU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbGUgZXhlY3V0aW5nIGluc3RydW1lbnQgdGVzdDonLCBlcnIuc3RhY2spO1xyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvblVzaW5nQWRia2l0ICgpIHtcclxuICAgIGNsaWVudC5saXN0RGV2aWNlcygpXHJcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRldmljZXMpIHtcclxuICAgICAgICAgIFByb21pc2UubWFwKGRldmljZXMsIGZ1bmN0aW9uIChkZXZpY2UpIHtcclxuICAgICAgICAgICAgbG9nZ2VyLmluZm8oXCJydW5uaW5nIGNvbW1hbmQuLi5cXG4gYWRiIHNoZWxsIGFtIGluc3RydW1lbnQgLXcgaW8uYXBwaXVtLnVpYXV0b21hdG9yMi5zZXJ2ZXIudGVzdC9hbmRyb2lkLnN1cHBvcnQudGVzdC5ydW5uZXIuQW5kcm9pZEpVbml0UnVubmVyLi4uIFwiKTtcclxuICAgICAgICAgICAgY2xpZW50LnNoZWxsKGRldmljZS5pZCwgXCJhbSBpbnN0cnVtZW50IC13IGlvLmFwcGl1bS51aWF1dG9tYXRvcjIuc2VydmVyLnRlc3QvYW5kcm9pZC5zdXBwb3J0LnRlc3QucnVubmVyLkFuZHJvaWRKVW5pdFJ1bm5lclwiKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcclxuICAgICAgICAgIGxvZ2dlci5lcnJvcignU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbGUgZXhlY3V0aW5nIGluc3RydW1lbnQgdGVzdDonLCBlcnIuc3RhY2spO1xyXG4gICAgICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XHJcbiAgICBsb2dnZXIuZGVidWcoJ0RlbGV0aW5nIFVpQXV0b21hdG9yMiBzZXJ2ZXIgc2Vzc2lvbicpO1xyXG4gICAgLy8gcmVseSBvbiBqd3Byb3h5J3MgaW50ZWxsaWdlbmNlIHRvIGtub3cgd2hhdCB3ZSdyZSB0YWxraW5nIGFib3V0IGFuZFxyXG4gICAgLy8gZGVsZXRlIHRoZSBjdXJyZW50IHNlc3Npb25cclxuICAgIHRyeSB7XHJcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvJywgJ0RFTEVURScpO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIGxvZ2dlci53YXJuKGBEaWQgbm90IGdldCBjb25maXJtYXRpb24gVWlBdXRvbWF0b3IyIGRlbGV0ZVNlc3Npb24gd29ya2VkOyBgICtcclxuICAgICAgICAgIGBFcnJvciB3YXM6ICR7ZXJyfWApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMga2lsbFVpQXV0b21hdG9yT25EZXZpY2UgKCkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgdGhpcy5hZGIua2lsbFByb2Nlc3Nlc0J5TmFtZSgnaW8uYXBwaXVtLnVpYXV0b21hdG9yMi5zZXJ2ZXInKTtcclxuICAgIH0gY2F0Y2ggKGlnbm9yZSkge1xyXG4gICAgICBsb2dnZXIuaW5mbyhcIlVuYWJsZSB0byBraWxsIHRoZSBpby5hcHBpdW0udWlhdXRvbWF0b3IyLnNlcnZlciBwcm9jZXNzLCBhc3N1bWluZyBpdCBpcyBhbHJlYWR5IGtpbGxlZFwiKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IFVpQXV0b21hdG9yMlNlcnZlcjtcclxuIl19
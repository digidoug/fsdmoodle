'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _teen_process = require('teen_process');

var _appiumBaseDriver = require('appium-base-driver');

var _appiumSupport = require('appium-support');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumLogger = require('appium-logger');

var _simulatorManagementJs = require('./simulator-management.js');

var _utilsJs = require('./utils.js');

var agentLog = (0, _appiumLogger.getLogger)('WebDriverAgent');
var xcodeLog = (0, _appiumLogger.getLogger)('Xcode');
var iproxyLog = (0, _appiumLogger.getLogger)('iProxy');

var BOOTSTRAP_PATH = _path2['default'].resolve(__dirname, '..', '..', 'WebDriverAgent');
var AGENT_LOG_PREFIX = 'XCTStubApps[';
var AGENT_RUNNER_LOG_PREFIX = 'XCTRunner[';
var SIM_BRIDGE_LOG_PREFIX = 'CoreSimulatorBridge[';
var AGENT_STARTED_REGEX = /ServerURLHere->(.*)<-ServerURLHere/;
var REAL_DEVICE_LOGGER_PATH = 'idevicesyslog';
var WDA_BUNDLE_ID = 'com.apple.test.WebDriverAgentRunner-Runner';

var WebDriverAgent = (function () {

  // agentPath (optional): Path to WebdriverAgent Executable (inside WebDriverAgent.app)

  function WebDriverAgent(xcodeVersion) {
    var args = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    _classCallCheck(this, WebDriverAgent);

    this.xcodeVersion = xcodeVersion;

    this.device = args.device;
    this.platformVersion = args.platformVersion;
    this.host = args.host;
    this.realDevice = !!args.realDevice;

    this.setWDAPaths(args.bootstrapPath, args.agentPath);

    this.realDeviceLogger = args.realDeviceLogger || REAL_DEVICE_LOGGER_PATH;
    this.wdaLocalPort = args.wdaLocalPort;
    this.iosLogAlreadyShown = args.showIOSLog;
    this.showXcodeLog = !!args.showXcodeLog;
    this.xcodeConfigFile = args.xcodeConfigFile;
    this.keychainPath = args.keychainPath;
    this.keychainPassword = args.keychainPassword;

    this.usePrebuiltWDA = args.usePrebuiltWDA;
    this.webDriverAgentUrl = args.webDriverAgentUrl;
  }

  _createClass(WebDriverAgent, [{
    key: 'setWDAPaths',
    value: function setWDAPaths(bootstrapPath, agentPath) {
      // allow the user to specify a place for WDA. This is undocumented and
      // only here for the purposes of testing development of WDA
      this.bootstrapPath = bootstrapPath || BOOTSTRAP_PATH;
      _logger2['default'].info('Using WDA path: \'' + this.bootstrapPath + '\'');

      // for backward compatibility we need to be able to specify agentPath too
      this.agentPath = agentPath || _path2['default'].resolve(this.bootstrapPath, 'WebDriverAgent.xcodeproj');
      _logger2['default'].info('Using WDA agent: \'' + this.agentPath + '\'');
    }
  }, {
    key: 'uninstall',
    value: function uninstall() {
      return _regeneratorRuntime.async(function uninstall$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Removing WDA application from device');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.device.removeApp(WDA_BUNDLE_ID));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'launch',
    value: function launch(sessionId) {
      var agentUrl, localport;
      return _regeneratorRuntime.async(function launch$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.webDriverAgentUrl) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].info('Using provided WebdriverAgent at \'' + this.webDriverAgentUrl + '\'');
            this.url = _url2['default'].parse(this.webDriverAgentUrl);
            this.setupProxy(sessionId);
            return context$2$0.abrupt('return', this.webDriverAgentUrl);

          case 5:

            _logger2['default'].info('Launching WebDriverAgent on the device');

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.agentPath));

          case 8:
            if (context$2$0.sent) {
              context$2$0.next = 10;
              break;
            }

            throw new Error('Trying to use WebDriverAgent project at \'' + this.agentPath + '\' but the ' + 'file does not exist');

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.checkForDependencies());

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.killHangingProcesses());

          case 14:
            if (!this.realDevice) {
              context$2$0.next = 20;
              break;
            }

            context$2$0.next = 17;
            return _regeneratorRuntime.awrap(this.createRealDeviceLogsSubProcess());

          case 17:
            this.deviceLogs = context$2$0.sent;
            context$2$0.next = 23;
            break;

          case 20:
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(this.createSimLogsSubProcess());

          case 22:
            this.deviceLogs = context$2$0.sent;

          case 23:
            context$2$0.next = 25;
            return _regeneratorRuntime.awrap(this.createXcodeBuildSubProcess());

          case 25:
            this.xcodebuild = context$2$0.sent;
            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(this.startXcodebuild());

          case 28:
            agentUrl = context$2$0.sent;

            this.url = _url2['default'].parse(agentUrl);

            this.url.hostname = 'localhost';

            if (!this.realDevice) {
              context$2$0.next = 37;
              break;
            }

            localport = this.wdaLocalPort || this.url.port;

            this.iproxy = this.createiProxySubProcess(localport, this.url.port);
            context$2$0.next = 36;
            return _regeneratorRuntime.awrap(this.startiproxy());

          case 36:
            this.url.port = localport;

          case 37:

            this.setupProxy(sessionId);

            return context$2$0.abrupt('return', agentUrl);

          case 39:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setupProxy',
    value: function setupProxy(sessionId) {
      this.jwproxy = new _appiumBaseDriver.JWProxy({ server: this.url.hostname, port: this.url.port, base: '' });
      this.jwproxy.sessionId = sessionId;
      this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    }
  }, {
    key: 'checkForDependencies',
    value: function checkForDependencies() {
      var carthagePath;
      return _regeneratorRuntime.async(function checkForDependencies$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.which('carthage'));

          case 3:
            carthagePath = context$2$0.sent;

            _logger2['default'].debug('Carthage found: ' + carthagePath);
            context$2$0.next = 10;
            break;

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](0);

            _logger2['default'].info('Carthage not found. Install using `brew install carthage`');

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(this.bootstrapPath + '/Carthage'));

          case 12:
            if (context$2$0.sent) {
              context$2$0.next = 16;
              break;
            }

            _logger2['default'].debug('Running WebDriverAgent bootstrap script to install dependencies');
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('/bin/bash', ['Scripts/bootstrap.sh', '-d'], { cwd: this.bootstrapPath }));

          case 16:
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(this.bootstrapPath + '/Resources'));

          case 18:
            if (context$2$0.sent) {
              context$2$0.next = 22;
              break;
            }

            _logger2['default'].debug('Creating WebDriverAgent resources directory');
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(this.bootstrapPath + '/Resources'));

          case 22:
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(this.bootstrapPath + '/Resources/WebDriverAgent.bundle'));

          case 24:
            if (context$2$0.sent) {
              context$2$0.next = 28;
              break;
            }

            _logger2['default'].debug('Creating WebDriverAgent resource bundle directory');
            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(this.bootstrapPath + '/Resources/WebDriverAgent.bundle'));

          case 28:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 7]]);
    }
  }, {
    key: 'getXcodeBuildCommand',
    value: function getXcodeBuildCommand() {
      var cmd = 'xcodebuild';
      var args = undefined;

      var GENERIC_ARGS = ['-project', this.agentPath, '-scheme', 'WebDriverAgentRunner', '-destination', 'id=' + this.device.udid, '-configuration', 'Debug'];

      if (this.realDevice) {
        var _args;

        args = ['build', 'test'];
        (_args = args).push.apply(_args, GENERIC_ARGS);
        if (this.xcodeConfigFile) {
          _logger2['default'].debug('Using Xcode configuration file: \'' + this.xcodeConfigFile + '\'');
          args.push('-xcconfig', this.xcodeConfigFile);
        }

        if (this.usePrebuiltWDA) {
          _logger2['default'].warn('\'usePrebuiltWDA\' set, but on real device, so skipping');
        }
      } else {
        var _args2;

        if (this.xcodeVersion.major < 8) {
          args = ['build', 'test'];
        } else {
          args = this.usePrebuiltWDA ? ['test-without-building'] : ['build-for-testing', 'test-without-building'];
        }
        (_args2 = args).push.apply(_args2, GENERIC_ARGS);
      }
      return { cmd: cmd, args: args };
    }
  }, {
    key: 'setRealDeviceSecurity',
    value: function setRealDeviceSecurity(keychainPath, keychainPassword) {
      return _regeneratorRuntime.async(function setRealDeviceSecurity$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Setting security for iOS device');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['-v', 'list-keychains', '-s', keychainPath]));

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['-v', 'unlock-keychain', '-p', keychainPassword, keychainPath]));

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['set-keychain-settings', '-t', '3600', '-l', keychainPath]));

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createXcodeBuildSubProcess',
    value: function createXcodeBuildSubProcess() {
      var _getXcodeBuildCommand, cmd, args, xcodebuild, logXcodeOutput;

      return _regeneratorRuntime.async(function createXcodeBuildSubProcess$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.realDevice) {
              context$2$0.next = 4;
              break;
            }

            if (!(this.keychainPath && this.keychainPassword)) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.setRealDeviceSecurity(this.keychainPath, this.keychainPassword));

          case 4:
            _getXcodeBuildCommand = this.getXcodeBuildCommand();
            cmd = _getXcodeBuildCommand.cmd;
            args = _getXcodeBuildCommand.args;

            _logger2['default'].debug('Beginning test with command \'' + cmd + ' ' + args.join(' ') + '\' ' + ('in directory \'' + this.bootstrapPath + '\''));
            xcodebuild = new _teen_process.SubProcess(cmd, args, { cwd: this.bootstrapPath });
            logXcodeOutput = this.showXcodeLog;

            xcodebuild.on('output', function (stdout, stderr) {
              var out = stdout || stderr;
              // we want to pull out the log file that is created, and highlight it
              // for diagnostic purposes
              if (out.indexOf('Writing diagnostic log for test session to') !== -1) {
                // pull out the first line that begins with the path separator
                // which *should* be the line indicating the log file generated
                var logLocation = _lodash2['default'].first(_lodash2['default'].remove(out.trim().split('\n'), function (v) {
                  return v.indexOf(_path2['default'].sep) === 0;
                }));
                _logger2['default'].debug('Log file for xcodebuild test: ' + logLocation);
              }

              // if we have an error we want to output the logs
              // otherwise the failure is inscrutible
              // but do not log permission errors from trying to write to attachments folder
              if (out.indexOf('Error Domain=') !== -1 && out.indexOf('Error writing attachment data to file') === -1) {
                logXcodeOutput = true;
              }

              if (logXcodeOutput) {
                xcodeLog.info(out);

                // terrible hack to handle case where xcode return 0 but is failing
                xcodebuild._wda_error_occurred = true;
              }
            });

            return context$2$0.abrupt('return', xcodebuild);

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createSimLogsSubProcess',
    value: function createSimLogsSubProcess() {
      var args, logs;
      return _regeneratorRuntime.async(function createSimLogsSubProcess$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            args = ['-f', '-n', '0', _path2['default'].resolve(this.device.getLogDir(), 'system.log')];
            logs = new _teen_process.SubProcess('tail', args);

            this.setupLogging(logs, 'Sim');
            return context$2$0.abrupt('return', logs);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createiProxySubProcess',
    value: function createiProxySubProcess(localport, deviceport) {
      _logger2['default'].debug('Starting iproxy to forward traffic from local port ' + localport + ' to device port ' + deviceport + ' over USB');
      return new _teen_process.SubProcess('iproxy', [localport, deviceport, this.device.udid]);
    }
  }, {
    key: 'createRealDeviceLogsSubProcess',
    value: function createRealDeviceLogsSubProcess() {
      var checkForLogger, stat, logs;
      return _regeneratorRuntime.async(function createRealDeviceLogsSubProcess$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            checkForLogger = function checkForLogger(logger) {
              return _regeneratorRuntime.async(function checkForLogger$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.prev = 0;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap(_appiumSupport.fs.which(logger));

                  case 3:
                    context$3$0.next = 10;
                    break;

                  case 5:
                    context$3$0.prev = 5;
                    context$3$0.t0 = context$3$0['catch'](0);
                    context$3$0.next = 9;
                    return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(logger));

                  case 9:
                    return context$3$0.abrupt('return', context$3$0.sent);

                  case 10:
                    return context$3$0.abrupt('return', true);

                  case 11:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, this, [[0, 5]]);
            };

            context$2$0.t0 = this.realDeviceLogger.indexOf('deviceconsole') !== -1;

            if (!context$2$0.t0) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.realDeviceLogger));

          case 5:
            context$2$0.t0 = context$2$0.sent;

          case 6:
            if (!context$2$0.t0) {
              context$2$0.next = 11;
              break;
            }

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.stat(this.realDeviceLogger));

          case 9:
            stat = context$2$0.sent;

            if (stat.isDirectory()) {
              _logger2['default'].warn('Real device logger \'' + this.realDeviceLogger + '\' is a directory. Appending \'deviceconsole\' executable');
              this.realDeviceLogger = _path2['default'].resolve(this.realDeviceLogger, 'deviceconsole');
            }

          case 11:
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(checkForLogger(this.realDeviceLogger));

          case 13:
            if (context$2$0.sent) {
              context$2$0.next = 15;
              break;
            }

            throw new Error('Unable to find real device logging program \'' + this.realDeviceLogger + '\'');

          case 15:
            _logger2['default'].debug('Using real device logger \'' + this.realDeviceLogger + '\'');

            logs = new _teen_process.SubProcess(this.realDeviceLogger, ['-u', this.device.udid]);

            this.setupLogging(logs, 'Device');
            return context$2$0.abrupt('return', logs);

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setupLogging',
    value: function setupLogging(logs, prefix) {
      var _this = this;

      var loggingStarted = !this.realDevice;
      var startTime = new Date();
      function shouldStartLogging(row) {
        var logRowParts = row.split(/\s+/);
        var logRowDate = new Date(startTime.getFullYear() + ' ' + logRowParts[0] + ' ' + logRowParts[1] + ' ' + logRowParts[2]);
        loggingStarted = logRowDate.isAfter(startTime);
        return loggingStarted;
      }

      function isPertinentLogLine(line) {
        return line.length && (line.indexOf(AGENT_LOG_PREFIX) !== -1 || line.indexOf(AGENT_RUNNER_LOG_PREFIX) !== -1 || line.indexOf(SIM_BRIDGE_LOG_PREFIX) !== -1);
      }

      if (this.realDevice && this.realDeviceLogger.indexOf('idevicesyslog') !== -1) {
        // we are using idevicesyslog, which sometimes cannot connect to the device
        // at which time the system will not be able to figure out that the process
        // has started
        logs.on('output', function (stdout, stderr) {
          var errorString = 'Could not start logger for udid';
          if (stdout.indexOf(errorString) !== -1 || stderr.indexOf(errorString) !== -1) {
            // unfortunately we have no way to stopping the process, so just log overtly
            var msg = 'The real device logger \'' + _this.realDeviceLogger + '\' was ' + 'unable to start log capture. Please try installing ' + '\'deviceconsole\' (\'npm install -g deviceconsole\') and ' + 'specify the path to it using the \'realDeviceLogger\' capability.';
            _logger2['default'].error(msg);
          }
        });
      }

      if (!this.iosLogAlreadyShown) {
        logs.on('output', function (stdout, stderr) {
          var out = stdout || stderr;
          // make sure we are not reading logs from before this test run
          if (!loggingStarted && !shouldStartLogging(out)) {
            return;
          }
          if (isPertinentLogLine(out)) {
            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
              for (var _iterator = _getIterator(out.split("\n").filter(Boolean)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                var line = _step.value;

                agentLog.debug(prefix + ': ' + line);
              }
            } catch (err) {
              _didIteratorError = true;
              _iteratorError = err;
            } finally {
              try {
                if (!_iteratorNormalCompletion && _iterator['return']) {
                  _iterator['return']();
                }
              } finally {
                if (_didIteratorError) {
                  throw _iteratorError;
                }
              }
            }
          }
        });
      }
    }
  }, {
    key: 'getStartTime',
    value: function getStartTime() {
      var startTime, _ref, stdout;

      return _regeneratorRuntime.async(function getStartTime$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            startTime = new Date();

            if (!this.realDevice) {
              context$2$0.next = 8;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('idevicedate', ['-u', this.device.udid]));

          case 4:
            _ref = context$2$0.sent;
            stdout = _ref.stdout;

            startTime = new Date(stdout);
            if (isNaN(startTime.getTime())) {
              _logger2['default'].debug('Unable to get device time. Using local system time');
              // there is never any stderr output, just stdout
              _logger2['default'].debug('Output from idevicedate: ' + stdout);
              startTime = new Date();
            }

          case 8:
            return context$2$0.abrupt('return', startTime);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startXcodebuild',
    value: function startXcodebuild() {
      return _regeneratorRuntime.async(function startXcodebuild$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function callee$2$0(resolve, reject) {
              var startTime, agentUrl, msg;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this2 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    this.xcodebuild.on('exit', function (code, signal) {
                      _logger2['default'].info('xcodebuild exited with code \'' + code + '\' and signal \'' + signal + '\'');
                      if (_this2.xcodebuild._wda_error_occurred || !signal && code !== 0) {
                        return reject(new Error('xcodebuild failed with code ' + code));
                      }
                    });

                    this.deviceLogs.on('exit', function (code) {
                      var msg = (_this2.realDevice ? 'System' : 'Simulator') + ' log exited with code \'' + code + '\'';
                      _logger2['default'].info(msg);
                      if (code) {
                        return reject(msg);
                      }
                    });

                    context$3$0.prev = 2;
                    context$3$0.next = 5;
                    return _regeneratorRuntime.awrap(this.getStartTime());

                  case 5:
                    startTime = context$3$0.sent;
                    context$3$0.next = 8;
                    return _regeneratorRuntime.awrap(this.xcodebuild.start());

                  case 8:
                    context$3$0.next = 10;
                    return _regeneratorRuntime.awrap(this.waitForStart(startTime));

                  case 10:
                    agentUrl = context$3$0.sent;

                    resolve(agentUrl);
                    context$3$0.next = 19;
                    break;

                  case 14:
                    context$3$0.prev = 14;
                    context$3$0.t0 = context$3$0['catch'](2);
                    msg = 'Unable to start WebDriverAgent: ' + context$3$0.t0;

                    _logger2['default'].error(msg);
                    return context$3$0.abrupt('return', reject(msg));

                  case 19:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3, [[2, 14]]);
            }));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForStart',
    value: function waitForStart(startTime) {
      var agentUrl, lineCount, showWaitingMessage, startDetector;
      return _regeneratorRuntime.async(function waitForStart$(context$2$0) {
        var _this4 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.realDevice) {
              context$2$0.next = 3;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _simulatorManagementJs.systemLogExists)(this.device));

          case 3:
            agentUrl = undefined;
            lineCount = 0;
            showWaitingMessage = true;

            startDetector = function startDetector(stdout) {
              var match = AGENT_STARTED_REGEX.exec(stdout);
              if (match) {
                if (_this4.realDevice) {
                  // on a real device there may already be system logs that need to be
                  // passed before we get to the real startup logs, otherwise
                  // it will be "done" before booting
                  // Expect a line like:
                  //     Dec  7 10:55:32 iamPhone XCTRunner(WebDriverAgentLib)[386] <Notice>: ServerURLHere->http://localhost:8100<-ServerURLHere
                  // need to get the date and add the year from the start date
                  var dateString = stdout.substr(0, 6) + ' ' + startTime.getFullYear() + ' ' + stdout.substr(7, 8);
                  var buildTime = new Date(dateString);
                  if (!buildTime.isAfter(startTime)) {
                    return false;
                  }
                }

                agentUrl = match[1];
                if (!agentUrl) {
                  _logger2['default'].errorAndThrow(new Error('No url detected from WebDriverAgent'));
                }
                _logger2['default'].info('Detected that WebDriverAgent is running at url \'' + agentUrl + '\'');
                showWaitingMessage = false;
                return true;
              }

              // periodically log, so it does not look like everything died
              lineCount++;
              var threshold = _this4.realDevice ? 5000 : 200;
              if (showWaitingMessage && lineCount % threshold === 0) {
                _logger2['default'].debug('Waiting for WebDriverAgent server to finish loading...');
              }

              return false;
            };

            _logger2['default'].info('Waiting for WebDriverAgent to start on device');
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.deviceLogs.start(startDetector));

          case 10:
            _logger2['default'].info('WebDriverAgent started at url \'' + agentUrl + '\'');

            return context$2$0.abrupt('return', agentUrl);

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startiproxy',
    value: function startiproxy() {
      return _regeneratorRuntime.async(function startiproxy$(context$2$0) {
        var _this5 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function callee$2$0(resolve, reject) {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    this.iproxy.on('exit', function (code) {
                      _logger2['default'].warn('iproxy exited with code \'' + code + '\'');
                      if (code) {
                        return reject(new Error('iproxy exited with code \'' + code + '\''));
                      }
                    });
                    this.iproxy.on('output', function (stdout, stderr) {
                      var out = stdout || stderr;
                      var _iteratorNormalCompletion2 = true;
                      var _didIteratorError2 = false;
                      var _iteratorError2 = undefined;

                      try {
                        for (var _iterator2 = _getIterator(out.split('\n')), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                          var line = _step2.value;

                          if (!line.length) continue;
                          iproxyLog.debug(line);
                        }
                      } catch (err) {
                        _didIteratorError2 = true;
                        _iteratorError2 = err;
                      } finally {
                        try {
                          if (!_iteratorNormalCompletion2 && _iterator2['return']) {
                            _iterator2['return']();
                          }
                        } finally {
                          if (_didIteratorError2) {
                            throw _iteratorError2;
                          }
                        }
                      }
                    });

                    context$3$0.prev = 2;
                    context$3$0.next = 5;
                    return _regeneratorRuntime.awrap(this.iproxy.start(5000));

                  case 5:
                    resolve();
                    context$3$0.next = 12;
                    break;

                  case 8:
                    context$3$0.prev = 8;
                    context$3$0.t0 = context$3$0['catch'](2);

                    _logger2['default'].error('Error starting iproxy: \'' + context$3$0.t0.message + '\'');
                    reject('Unable to start iproxy. Is it installed?');

                  case 12:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this5, [[2, 8]]);
            }));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'killHangingProcesses',
    value: function killHangingProcesses() {
      var procNames, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, proc;

      return _regeneratorRuntime.async(function killHangingProcesses$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Killing hanging processes');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _utilsJs.killAppUsingAppName)(this.device.udid, 'xcodebuild'));

          case 3:
            procNames = this.realDevice ? [this.realDeviceLogger, 'iproxy'] : ['tail', 'XCTRunner'];
            _iteratorNormalCompletion3 = true;
            _didIteratorError3 = false;
            _iteratorError3 = undefined;
            context$2$0.prev = 7;
            _iterator3 = _getIterator(procNames);

          case 9:
            if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
              context$2$0.next = 16;
              break;
            }

            proc = _step3.value;
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap((0, _utilsJs.killAppUsingAppName)(this.device.udid, proc));

          case 13:
            _iteratorNormalCompletion3 = true;
            context$2$0.next = 9;
            break;

          case 16:
            context$2$0.next = 22;
            break;

          case 18:
            context$2$0.prev = 18;
            context$2$0.t0 = context$2$0['catch'](7);
            _didIteratorError3 = true;
            _iteratorError3 = context$2$0.t0;

          case 22:
            context$2$0.prev = 22;
            context$2$0.prev = 23;

            if (!_iteratorNormalCompletion3 && _iterator3['return']) {
              _iterator3['return']();
            }

          case 25:
            context$2$0.prev = 25;

            if (!_didIteratorError3) {
              context$2$0.next = 28;
              break;
            }

            throw _iteratorError3;

          case 28:
            return context$2$0.finish(25);

          case 29:
            return context$2$0.finish(22);

          case 30:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[7, 18, 22, 30], [23,, 25, 29]]);
    }
  }, {
    key: 'quit',
    value: function quit() {
      var killProcess;
      return _regeneratorRuntime.async(function quit$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            killProcess = function killProcess(name, proc) {
              return _regeneratorRuntime.async(function killProcess$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    if (!(proc && proc.proc)) {
                      context$3$0.next = 22;
                      break;
                    }

                    _logger2['default'].info('Shutting down ' + name + ' process (pid ' + proc.proc.pid + ')');
                    context$3$0.prev = 2;
                    context$3$0.next = 5;
                    return _regeneratorRuntime.awrap(proc.stop('SIGTERM'));

                  case 5:
                    context$3$0.next = 22;
                    break;

                  case 7:
                    context$3$0.prev = 7;
                    context$3$0.t0 = context$3$0['catch'](2);

                    if (!(context$3$0.t0.message.indexOf('Process didn\'t end after') === -1)) {
                      context$3$0.next = 11;
                      break;
                    }

                    throw context$3$0.t0;

                  case 11:
                    _logger2['default'].debug(name + ' process did not end in a timely fashion: \'' + context$3$0.t0.message + '\'. ' + 'Sending \'SIGKILL\'...');
                    context$3$0.prev = 12;
                    context$3$0.next = 15;
                    return _regeneratorRuntime.awrap(proc.stop('SIGKILL'));

                  case 15:
                    context$3$0.next = 22;
                    break;

                  case 17:
                    context$3$0.prev = 17;
                    context$3$0.t1 = context$3$0['catch'](12);

                    if (!(context$3$0.t1.message.indexOf('not currently running') !== -1)) {
                      context$3$0.next = 21;
                      break;
                    }

                    return context$3$0.abrupt('return');

                  case 21:
                    throw context$3$0.t1;

                  case 22:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, this, [[2, 7], [12, 17]]);
            };

            _logger2['default'].info('Shutting down sub-processes');

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(killProcess('xcodebuild', this.xcodebuild));

          case 4:
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(killProcess('Logger', this.deviceLogs));

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(killProcess('iproxy', this.iproxy));

          case 8:

            if (this.jwproxy) {
              this.jwproxy.sessionId = null;
            }

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return WebDriverAgent;
})();

exports['default'] = WebDriverAgent;
exports.WebDriverAgent = WebDriverAgent;
exports.WDA_BUNDLE_ID = WDA_BUNDLE_ID;
exports.BOOTSTRAP_PATH = BOOTSTRAP_PATH;

// make sure that the WDA library has been built

//kill all hanging processes

// start the logging process

// start the xcodebuild process

// the logger can be the name of a program on the PATH
// or a path to the program

// not on the PATH, so see if it is an accessible path itself

// no error thrown, so all is well

// the user might have passed in the directory for `deviceconsole`, in which case we want to
// make sure we use the executable

// we have no logger

// wrap the start procedure in a promise so that we can catch, and report,
// any startup errors that are thrown as events

// we have to wait for the sim to start before we can tail the log file
// turn off logging once we have hit the end

// the process ended but for some reason we were not informed
//# sourceMappingURL=data:application/json;charset=utf8;base64,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MUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDOzs7OzZDQUN0QyxXQUFXLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUM7Ozs7QUFFeEMsZ0JBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtBQUNoQixrQkFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO2FBQy9COzs7Ozs7O0tBQ0Y7OztTQTlkRyxjQUFjOzs7cUJBaWVMLGNBQWM7UUFDcEIsY0FBYyxHQUFkLGNBQWM7UUFBRSxhQUFhLEdBQWIsYUFBYTtRQUFFLGNBQWMsR0FBZCxjQUFjIiwiZmlsZSI6ImxpYi93ZWJkcml2ZXJhZ2VudC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IFN1YlByb2Nlc3MsIGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgSldQcm94eSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgZ2V0TG9nZ2VyIH0gZnJvbSAnYXBwaXVtLWxvZ2dlcic7XG5pbXBvcnQgeyBzeXN0ZW1Mb2dFeGlzdHMgfSBmcm9tICcuL3NpbXVsYXRvci1tYW5hZ2VtZW50LmpzJztcbmltcG9ydCB7IGtpbGxBcHBVc2luZ0FwcE5hbWUgfSBmcm9tICcuL3V0aWxzLmpzJztcblxuY29uc3QgYWdlbnRMb2cgPSBnZXRMb2dnZXIoJ1dlYkRyaXZlckFnZW50Jyk7XG5jb25zdCB4Y29kZUxvZyA9IGdldExvZ2dlcignWGNvZGUnKTtcbmNvbnN0IGlwcm94eUxvZyA9IGdldExvZ2dlcignaVByb3h5Jyk7XG5cbmNvbnN0IEJPT1RTVFJBUF9QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ1dlYkRyaXZlckFnZW50Jyk7XG5jb25zdCBBR0VOVF9MT0dfUFJFRklYID0gJ1hDVFN0dWJBcHBzWyc7XG5jb25zdCBBR0VOVF9SVU5ORVJfTE9HX1BSRUZJWCA9ICdYQ1RSdW5uZXJbJztcbmNvbnN0IFNJTV9CUklER0VfTE9HX1BSRUZJWCA9ICdDb3JlU2ltdWxhdG9yQnJpZGdlWyc7XG5jb25zdCBBR0VOVF9TVEFSVEVEX1JFR0VYID0gL1NlcnZlclVSTEhlcmUtPiguKik8LVNlcnZlclVSTEhlcmUvO1xuY29uc3QgUkVBTF9ERVZJQ0VfTE9HR0VSX1BBVEggPSAnaWRldmljZXN5c2xvZyc7XG5jb25zdCBXREFfQlVORExFX0lEID0gJ2NvbS5hcHBsZS50ZXN0LldlYkRyaXZlckFnZW50UnVubmVyLVJ1bm5lcic7XG5cbmNsYXNzIFdlYkRyaXZlckFnZW50IHtcblxuICAvLyBhZ2VudFBhdGggKG9wdGlvbmFsKTogUGF0aCB0byBXZWJkcml2ZXJBZ2VudCBFeGVjdXRhYmxlIChpbnNpZGUgV2ViRHJpdmVyQWdlbnQuYXBwKVxuICBjb25zdHJ1Y3RvciAoeGNvZGVWZXJzaW9uLCBhcmdzID0ge30pIHtcbiAgICB0aGlzLnhjb2RlVmVyc2lvbiA9IHhjb2RlVmVyc2lvbjtcblxuICAgIHRoaXMuZGV2aWNlID0gYXJncy5kZXZpY2U7XG4gICAgdGhpcy5wbGF0Zm9ybVZlcnNpb24gPSBhcmdzLnBsYXRmb3JtVmVyc2lvbjtcbiAgICB0aGlzLmhvc3QgPSBhcmdzLmhvc3Q7XG4gICAgdGhpcy5yZWFsRGV2aWNlID0gISFhcmdzLnJlYWxEZXZpY2U7XG5cbiAgICB0aGlzLnNldFdEQVBhdGhzKGFyZ3MuYm9vdHN0cmFwUGF0aCwgYXJncy5hZ2VudFBhdGgpO1xuXG4gICAgdGhpcy5yZWFsRGV2aWNlTG9nZ2VyID0gYXJncy5yZWFsRGV2aWNlTG9nZ2VyIHx8IFJFQUxfREVWSUNFX0xPR0dFUl9QQVRIO1xuICAgIHRoaXMud2RhTG9jYWxQb3J0ID0gYXJncy53ZGFMb2NhbFBvcnQ7XG4gICAgdGhpcy5pb3NMb2dBbHJlYWR5U2hvd24gPSBhcmdzLnNob3dJT1NMb2c7XG4gICAgdGhpcy5zaG93WGNvZGVMb2cgPSAhIWFyZ3Muc2hvd1hjb2RlTG9nO1xuICAgIHRoaXMueGNvZGVDb25maWdGaWxlID0gYXJncy54Y29kZUNvbmZpZ0ZpbGU7XG4gICAgdGhpcy5rZXljaGFpblBhdGggPSBhcmdzLmtleWNoYWluUGF0aDtcbiAgICB0aGlzLmtleWNoYWluUGFzc3dvcmQgPSBhcmdzLmtleWNoYWluUGFzc3dvcmQ7XG5cbiAgICB0aGlzLnVzZVByZWJ1aWx0V0RBID0gYXJncy51c2VQcmVidWlsdFdEQTtcbiAgICB0aGlzLndlYkRyaXZlckFnZW50VXJsID0gYXJncy53ZWJEcml2ZXJBZ2VudFVybDtcbiAgfVxuXG4gIHNldFdEQVBhdGhzIChib290c3RyYXBQYXRoLCBhZ2VudFBhdGgpIHtcbiAgICAvLyBhbGxvdyB0aGUgdXNlciB0byBzcGVjaWZ5IGEgcGxhY2UgZm9yIFdEQS4gVGhpcyBpcyB1bmRvY3VtZW50ZWQgYW5kXG4gICAgLy8gb25seSBoZXJlIGZvciB0aGUgcHVycG9zZXMgb2YgdGVzdGluZyBkZXZlbG9wbWVudCBvZiBXREFcbiAgICB0aGlzLmJvb3RzdHJhcFBhdGggPSBib290c3RyYXBQYXRoIHx8IEJPT1RTVFJBUF9QQVRIO1xuICAgIGxvZy5pbmZvKGBVc2luZyBXREEgcGF0aDogJyR7dGhpcy5ib290c3RyYXBQYXRofSdgKTtcblxuICAgIC8vIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5IHdlIG5lZWQgdG8gYmUgYWJsZSB0byBzcGVjaWZ5IGFnZW50UGF0aCB0b29cbiAgICB0aGlzLmFnZW50UGF0aCA9IGFnZW50UGF0aCB8fCBwYXRoLnJlc29sdmUodGhpcy5ib290c3RyYXBQYXRoLCAnV2ViRHJpdmVyQWdlbnQueGNvZGVwcm9qJyk7XG4gICAgbG9nLmluZm8oYFVzaW5nIFdEQSBhZ2VudDogJyR7dGhpcy5hZ2VudFBhdGh9J2ApO1xuICB9XG5cbiAgYXN5bmMgdW5pbnN0YWxsICgpIHtcbiAgICBsb2cuZGVidWcoYFJlbW92aW5nIFdEQSBhcHBsaWNhdGlvbiBmcm9tIGRldmljZWApO1xuICAgIGF3YWl0IHRoaXMuZGV2aWNlLnJlbW92ZUFwcChXREFfQlVORExFX0lEKTtcbiAgfVxuXG4gIGFzeW5jIGxhdW5jaCAoc2Vzc2lvbklkKSB7XG4gICAgaWYgKHRoaXMud2ViRHJpdmVyQWdlbnRVcmwpIHtcbiAgICAgIGxvZy5pbmZvKGBVc2luZyBwcm92aWRlZCBXZWJkcml2ZXJBZ2VudCBhdCAnJHt0aGlzLndlYkRyaXZlckFnZW50VXJsfSdgKTtcbiAgICAgIHRoaXMudXJsID0gdXJsLnBhcnNlKHRoaXMud2ViRHJpdmVyQWdlbnRVcmwpO1xuICAgICAgdGhpcy5zZXR1cFByb3h5KHNlc3Npb25JZCk7XG4gICAgICByZXR1cm4gdGhpcy53ZWJEcml2ZXJBZ2VudFVybDtcbiAgICB9XG5cbiAgICBsb2cuaW5mbygnTGF1bmNoaW5nIFdlYkRyaXZlckFnZW50IG9uIHRoZSBkZXZpY2UnKTtcblxuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHRoaXMuYWdlbnRQYXRoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcnlpbmcgdG8gdXNlIFdlYkRyaXZlckFnZW50IHByb2plY3QgYXQgJyR7dGhpcy5hZ2VudFBhdGh9JyBidXQgdGhlIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICdmaWxlIGRvZXMgbm90IGV4aXN0Jyk7XG4gICAgfVxuXG4gICAgLy8gbWFrZSBzdXJlIHRoYXQgdGhlIFdEQSBsaWJyYXJ5IGhhcyBiZWVuIGJ1aWx0XG4gICAgYXdhaXQgdGhpcy5jaGVja0ZvckRlcGVuZGVuY2llcygpO1xuXG4gICAgLy9raWxsIGFsbCBoYW5naW5nIHByb2Nlc3Nlc1xuICAgIGF3YWl0IHRoaXMua2lsbEhhbmdpbmdQcm9jZXNzZXMoKTtcblxuICAgIC8vIHN0YXJ0IHRoZSBsb2dnaW5nIHByb2Nlc3NcbiAgICBpZiAodGhpcy5yZWFsRGV2aWNlKSB7XG4gICAgICB0aGlzLmRldmljZUxvZ3MgPSBhd2FpdCB0aGlzLmNyZWF0ZVJlYWxEZXZpY2VMb2dzU3ViUHJvY2VzcygpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRldmljZUxvZ3MgPSBhd2FpdCB0aGlzLmNyZWF0ZVNpbUxvZ3NTdWJQcm9jZXNzKCk7XG4gICAgfVxuXG4gICAgdGhpcy54Y29kZWJ1aWxkID0gYXdhaXQgdGhpcy5jcmVhdGVYY29kZUJ1aWxkU3ViUHJvY2VzcygpO1xuXG4gICAgLy8gc3RhcnQgdGhlIHhjb2RlYnVpbGQgcHJvY2Vzc1xuICAgIGxldCBhZ2VudFVybCA9IGF3YWl0IHRoaXMuc3RhcnRYY29kZWJ1aWxkKCk7XG5cbiAgICB0aGlzLnVybCA9IHVybC5wYXJzZShhZ2VudFVybCk7XG5cbiAgICB0aGlzLnVybC5ob3N0bmFtZSA9ICdsb2NhbGhvc3QnO1xuICAgIGlmICh0aGlzLnJlYWxEZXZpY2UpIHtcbiAgICAgIGxldCBsb2NhbHBvcnQgPSB0aGlzLndkYUxvY2FsUG9ydCB8fCB0aGlzLnVybC5wb3J0O1xuICAgICAgdGhpcy5pcHJveHkgPSB0aGlzLmNyZWF0ZWlQcm94eVN1YlByb2Nlc3MobG9jYWxwb3J0LCB0aGlzLnVybC5wb3J0KTtcbiAgICAgIGF3YWl0IHRoaXMuc3RhcnRpcHJveHkoKTtcbiAgICAgIHRoaXMudXJsLnBvcnQgPSBsb2NhbHBvcnQ7XG4gICAgfVxuXG4gICAgdGhpcy5zZXR1cFByb3h5KHNlc3Npb25JZCk7XG5cbiAgICByZXR1cm4gYWdlbnRVcmw7XG4gIH1cblxuICBzZXR1cFByb3h5IChzZXNzaW9uSWQpIHtcbiAgICB0aGlzLmp3cHJveHkgPSBuZXcgSldQcm94eSh7c2VydmVyOiB0aGlzLnVybC5ob3N0bmFtZSwgcG9ydDogdGhpcy51cmwucG9ydCwgYmFzZTogJyd9KTtcbiAgICB0aGlzLmp3cHJveHkuc2Vzc2lvbklkID0gc2Vzc2lvbklkO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuICB9XG5cbiAgYXN5bmMgY2hlY2tGb3JEZXBlbmRlbmNpZXMgKCkge1xuICAgIHRyeSB7XG4gICAgICBsZXQgY2FydGhhZ2VQYXRoID0gYXdhaXQgZnMud2hpY2goJ2NhcnRoYWdlJyk7XG4gICAgICBsb2cuZGVidWcoYENhcnRoYWdlIGZvdW5kOiAke2NhcnRoYWdlUGF0aH1gKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5pbmZvKCdDYXJ0aGFnZSBub3QgZm91bmQuIEluc3RhbGwgdXNpbmcgYGJyZXcgaW5zdGFsbCBjYXJ0aGFnZWAnKTtcbiAgICB9XG4gICAgaWYgKCFhd2FpdCBmcy5oYXNBY2Nlc3MoYCR7dGhpcy5ib290c3RyYXBQYXRofS9DYXJ0aGFnZWApKSB7XG4gICAgICBsb2cuZGVidWcoJ1J1bm5pbmcgV2ViRHJpdmVyQWdlbnQgYm9vdHN0cmFwIHNjcmlwdCB0byBpbnN0YWxsIGRlcGVuZGVuY2llcycpO1xuICAgICAgYXdhaXQgZXhlYygnL2Jpbi9iYXNoJywgWydTY3JpcHRzL2Jvb3RzdHJhcC5zaCcsICctZCddLCB7Y3dkOiB0aGlzLmJvb3RzdHJhcFBhdGh9KTtcbiAgICB9XG4gICAgaWYgKCFhd2FpdCBmcy5oYXNBY2Nlc3MoYCR7dGhpcy5ib290c3RyYXBQYXRofS9SZXNvdXJjZXNgKSkge1xuICAgICAgbG9nLmRlYnVnKCdDcmVhdGluZyBXZWJEcml2ZXJBZ2VudCByZXNvdXJjZXMgZGlyZWN0b3J5Jyk7XG4gICAgICBhd2FpdCBmcy5ta2RpcihgJHt0aGlzLmJvb3RzdHJhcFBhdGh9L1Jlc291cmNlc2ApO1xuICAgIH1cbiAgICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhgJHt0aGlzLmJvb3RzdHJhcFBhdGh9L1Jlc291cmNlcy9XZWJEcml2ZXJBZ2VudC5idW5kbGVgKSkge1xuICAgICAgbG9nLmRlYnVnKCdDcmVhdGluZyBXZWJEcml2ZXJBZ2VudCByZXNvdXJjZSBidW5kbGUgZGlyZWN0b3J5Jyk7XG4gICAgICBhd2FpdCBmcy5ta2RpcihgJHt0aGlzLmJvb3RzdHJhcFBhdGh9L1Jlc291cmNlcy9XZWJEcml2ZXJBZ2VudC5idW5kbGVgKTtcbiAgICB9XG4gIH1cblxuICBnZXRYY29kZUJ1aWxkQ29tbWFuZCAoKSB7XG4gICAgbGV0IGNtZCA9ICd4Y29kZWJ1aWxkJztcbiAgICBsZXQgYXJncztcblxuICAgIGNvbnN0IEdFTkVSSUNfQVJHUyA9IFtcbiAgICAgICctcHJvamVjdCcsIHRoaXMuYWdlbnRQYXRoLFxuICAgICAgJy1zY2hlbWUnLCAnV2ViRHJpdmVyQWdlbnRSdW5uZXInLFxuICAgICAgJy1kZXN0aW5hdGlvbicsIGBpZD0ke3RoaXMuZGV2aWNlLnVkaWR9YCxcbiAgICAgICctY29uZmlndXJhdGlvbicsICdEZWJ1ZydcbiAgICBdO1xuXG4gICAgaWYgKHRoaXMucmVhbERldmljZSkge1xuICAgICAgYXJncyA9IFsnYnVpbGQnLCAndGVzdCddO1xuICAgICAgYXJncy5wdXNoKC4uLkdFTkVSSUNfQVJHUyk7XG4gICAgICBpZiAodGhpcy54Y29kZUNvbmZpZ0ZpbGUpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBVc2luZyBYY29kZSBjb25maWd1cmF0aW9uIGZpbGU6ICcke3RoaXMueGNvZGVDb25maWdGaWxlfSdgKTtcbiAgICAgICAgYXJncy5wdXNoKCcteGNjb25maWcnLCB0aGlzLnhjb2RlQ29uZmlnRmlsZSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLnVzZVByZWJ1aWx0V0RBKSB7XG4gICAgICAgIGxvZy53YXJuKGAndXNlUHJlYnVpbHRXREEnIHNldCwgYnV0IG9uIHJlYWwgZGV2aWNlLCBzbyBza2lwcGluZ2ApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy54Y29kZVZlcnNpb24ubWFqb3IgPCA4KSB7XG4gICAgICAgIGFyZ3MgPVtcbiAgICAgICAgICAnYnVpbGQnLFxuICAgICAgICAgICd0ZXN0JyxcbiAgICAgICAgXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFyZ3MgPSB0aGlzLnVzZVByZWJ1aWx0V0RBID8gW1xuICAgICAgICAgICd0ZXN0LXdpdGhvdXQtYnVpbGRpbmcnXG4gICAgICAgIF0gOiBbXG4gICAgICAgICAgJ2J1aWxkLWZvci10ZXN0aW5nJyxcbiAgICAgICAgICAndGVzdC13aXRob3V0LWJ1aWxkaW5nJ1xuICAgICAgICBdO1xuICAgICAgfVxuICAgICAgYXJncy5wdXNoKC4uLkdFTkVSSUNfQVJHUyk7XG4gICAgfVxuICAgIHJldHVybiB7Y21kLCBhcmdzfTtcbiAgfVxuXG4gIGFzeW5jIHNldFJlYWxEZXZpY2VTZWN1cml0eSAoa2V5Y2hhaW5QYXRoLCBrZXljaGFpblBhc3N3b3JkKSB7XG4gICAgbG9nLmRlYnVnKCdTZXR0aW5nIHNlY3VyaXR5IGZvciBpT1MgZGV2aWNlJyk7XG4gICAgYXdhaXQgZXhlYygnc2VjdXJpdHknLCBbJy12JywgJ2xpc3Qta2V5Y2hhaW5zJywgJy1zJywga2V5Y2hhaW5QYXRoXSk7XG4gICAgYXdhaXQgZXhlYygnc2VjdXJpdHknLCBbJy12JywgJ3VubG9jay1rZXljaGFpbicsICctcCcsIGtleWNoYWluUGFzc3dvcmQsIGtleWNoYWluUGF0aF0pO1xuICAgIGF3YWl0IGV4ZWMoJ3NlY3VyaXR5JywgWydzZXQta2V5Y2hhaW4tc2V0dGluZ3MnLCAnLXQnLCAnMzYwMCcsICctbCcsIGtleWNoYWluUGF0aF0pO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlWGNvZGVCdWlsZFN1YlByb2Nlc3MgKCkge1xuICAgIGlmICh0aGlzLnJlYWxEZXZpY2UpIHtcbiAgICAgIGlmICh0aGlzLmtleWNoYWluUGF0aCAmJiB0aGlzLmtleWNoYWluUGFzc3dvcmQpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5zZXRSZWFsRGV2aWNlU2VjdXJpdHkodGhpcy5rZXljaGFpblBhdGgsIHRoaXMua2V5Y2hhaW5QYXNzd29yZCk7XG4gICAgICB9XG4gICAgfVxuICAgIGxldCB7Y21kLCBhcmdzfSA9IHRoaXMuZ2V0WGNvZGVCdWlsZENvbW1hbmQoKTtcbiAgICBsb2cuZGVidWcoYEJlZ2lubmluZyB0ZXN0IHdpdGggY29tbWFuZCAnJHtjbWR9ICR7YXJncy5qb2luKCcgJyl9JyBgICtcbiAgICAgICAgICAgICAgYGluIGRpcmVjdG9yeSAnJHt0aGlzLmJvb3RzdHJhcFBhdGh9J2ApO1xuICAgIGxldCB4Y29kZWJ1aWxkID0gbmV3IFN1YlByb2Nlc3MoY21kLCBhcmdzLCB7Y3dkOiB0aGlzLmJvb3RzdHJhcFBhdGh9KTtcblxuICAgIGxldCBsb2dYY29kZU91dHB1dCA9IHRoaXMuc2hvd1hjb2RlTG9nO1xuICAgIHhjb2RlYnVpbGQub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgbGV0IG91dCA9IHN0ZG91dCB8fCBzdGRlcnI7XG4gICAgICAvLyB3ZSB3YW50IHRvIHB1bGwgb3V0IHRoZSBsb2cgZmlsZSB0aGF0IGlzIGNyZWF0ZWQsIGFuZCBoaWdobGlnaHQgaXRcbiAgICAgIC8vIGZvciBkaWFnbm9zdGljIHB1cnBvc2VzXG4gICAgICBpZiAob3V0LmluZGV4T2YoJ1dyaXRpbmcgZGlhZ25vc3RpYyBsb2cgZm9yIHRlc3Qgc2Vzc2lvbiB0bycpICE9PSAtMSkge1xuICAgICAgICAvLyBwdWxsIG91dCB0aGUgZmlyc3QgbGluZSB0aGF0IGJlZ2lucyB3aXRoIHRoZSBwYXRoIHNlcGFyYXRvclxuICAgICAgICAvLyB3aGljaCAqc2hvdWxkKiBiZSB0aGUgbGluZSBpbmRpY2F0aW5nIHRoZSBsb2cgZmlsZSBnZW5lcmF0ZWRcbiAgICAgICAgbGV0IGxvZ0xvY2F0aW9uID0gXy5maXJzdChfLnJlbW92ZShvdXQudHJpbSgpLnNwbGl0KCdcXG4nKSwgKHYpID0+IHYuaW5kZXhPZihwYXRoLnNlcCkgPT09IDApKTtcbiAgICAgICAgbG9nLmRlYnVnKGBMb2cgZmlsZSBmb3IgeGNvZGVidWlsZCB0ZXN0OiAke2xvZ0xvY2F0aW9ufWApO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiB3ZSBoYXZlIGFuIGVycm9yIHdlIHdhbnQgdG8gb3V0cHV0IHRoZSBsb2dzXG4gICAgICAvLyBvdGhlcndpc2UgdGhlIGZhaWx1cmUgaXMgaW5zY3J1dGlibGVcbiAgICAgIC8vIGJ1dCBkbyBub3QgbG9nIHBlcm1pc3Npb24gZXJyb3JzIGZyb20gdHJ5aW5nIHRvIHdyaXRlIHRvIGF0dGFjaG1lbnRzIGZvbGRlclxuICAgICAgaWYgKG91dC5pbmRleE9mKCdFcnJvciBEb21haW49JykgIT09IC0xICYmIG91dC5pbmRleE9mKCdFcnJvciB3cml0aW5nIGF0dGFjaG1lbnQgZGF0YSB0byBmaWxlJykgPT09IC0xKSB7XG4gICAgICAgIGxvZ1hjb2RlT3V0cHV0ID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKGxvZ1hjb2RlT3V0cHV0KSB7XG4gICAgICAgIHhjb2RlTG9nLmluZm8ob3V0KTtcblxuICAgICAgICAvLyB0ZXJyaWJsZSBoYWNrIHRvIGhhbmRsZSBjYXNlIHdoZXJlIHhjb2RlIHJldHVybiAwIGJ1dCBpcyBmYWlsaW5nXG4gICAgICAgIHhjb2RlYnVpbGQuX3dkYV9lcnJvcl9vY2N1cnJlZCA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4geGNvZGVidWlsZDtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNpbUxvZ3NTdWJQcm9jZXNzICgpIHtcbiAgICBsZXQgYXJncyA9IFtcbiAgICAgICctZicsXG4gICAgICAnLW4nLCAnMCcsXG4gICAgICBwYXRoLnJlc29sdmUodGhpcy5kZXZpY2UuZ2V0TG9nRGlyKCksICdzeXN0ZW0ubG9nJylcbiAgICBdO1xuXG4gICAgbGV0IGxvZ3MgPSBuZXcgU3ViUHJvY2VzcygndGFpbCcsIGFyZ3MpO1xuICAgIHRoaXMuc2V0dXBMb2dnaW5nKGxvZ3MsICdTaW0nKTtcbiAgICByZXR1cm4gbG9ncztcbiAgfVxuXG4gIGNyZWF0ZWlQcm94eVN1YlByb2Nlc3MgKGxvY2FscG9ydCwgZGV2aWNlcG9ydCkge1xuICAgIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgaXByb3h5IHRvIGZvcndhcmQgdHJhZmZpYyBmcm9tIGxvY2FsIHBvcnQgJHtsb2NhbHBvcnR9IHRvIGRldmljZSBwb3J0ICR7ZGV2aWNlcG9ydH0gb3ZlciBVU0JgKTtcbiAgICByZXR1cm4gbmV3IFN1YlByb2Nlc3MoYGlwcm94eWAsIFtsb2NhbHBvcnQsIGRldmljZXBvcnQsIHRoaXMuZGV2aWNlLnVkaWRdKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVJlYWxEZXZpY2VMb2dzU3ViUHJvY2VzcyAoKSB7XG4gICAgYXN5bmMgZnVuY3Rpb24gY2hlY2tGb3JMb2dnZXIgKGxvZ2dlcikge1xuICAgICAgLy8gdGhlIGxvZ2dlciBjYW4gYmUgdGhlIG5hbWUgb2YgYSBwcm9ncmFtIG9uIHRoZSBQQVRIXG4gICAgICAvLyBvciBhIHBhdGggdG8gdGhlIHByb2dyYW1cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZzLndoaWNoKGxvZ2dlcik7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLy8gbm90IG9uIHRoZSBQQVRILCBzbyBzZWUgaWYgaXQgaXMgYW4gYWNjZXNzaWJsZSBwYXRoIGl0c2VsZlxuICAgICAgICByZXR1cm4gYXdhaXQgZnMuZXhpc3RzKGxvZ2dlcik7XG4gICAgICB9XG5cbiAgICAgIC8vIG5vIGVycm9yIHRocm93biwgc28gYWxsIGlzIHdlbGxcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJlYWxEZXZpY2VMb2dnZXIuaW5kZXhPZignZGV2aWNlY29uc29sZScpICE9PSAtMSAmJiBhd2FpdCBmcy5leGlzdHModGhpcy5yZWFsRGV2aWNlTG9nZ2VyKSkge1xuICAgICAgLy8gdGhlIHVzZXIgbWlnaHQgaGF2ZSBwYXNzZWQgaW4gdGhlIGRpcmVjdG9yeSBmb3IgYGRldmljZWNvbnNvbGVgLCBpbiB3aGljaCBjYXNlIHdlIHdhbnQgdG9cbiAgICAgIC8vIG1ha2Ugc3VyZSB3ZSB1c2UgdGhlIGV4ZWN1dGFibGVcbiAgICAgIGxldCBzdGF0ID0gYXdhaXQgZnMuc3RhdCh0aGlzLnJlYWxEZXZpY2VMb2dnZXIpO1xuICAgICAgaWYgKHN0YXQuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICBsb2cud2FybihgUmVhbCBkZXZpY2UgbG9nZ2VyICcke3RoaXMucmVhbERldmljZUxvZ2dlcn0nIGlzIGEgZGlyZWN0b3J5LiBBcHBlbmRpbmcgJ2RldmljZWNvbnNvbGUnIGV4ZWN1dGFibGVgKTtcbiAgICAgICAgdGhpcy5yZWFsRGV2aWNlTG9nZ2VyID0gcGF0aC5yZXNvbHZlKHRoaXMucmVhbERldmljZUxvZ2dlciwgJ2RldmljZWNvbnNvbGUnKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWF3YWl0IGNoZWNrRm9yTG9nZ2VyKHRoaXMucmVhbERldmljZUxvZ2dlcikpIHtcbiAgICAgIC8vIHdlIGhhdmUgbm8gbG9nZ2VyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBmaW5kIHJlYWwgZGV2aWNlIGxvZ2dpbmcgcHJvZ3JhbSAnJHt0aGlzLnJlYWxEZXZpY2VMb2dnZXJ9J2ApO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFVzaW5nIHJlYWwgZGV2aWNlIGxvZ2dlciAnJHt0aGlzLnJlYWxEZXZpY2VMb2dnZXJ9J2ApO1xuXG4gICAgbGV0IGxvZ3MgPSBuZXcgU3ViUHJvY2Vzcyh0aGlzLnJlYWxEZXZpY2VMb2dnZXIsIFsnLXUnLCB0aGlzLmRldmljZS51ZGlkXSk7XG4gICAgdGhpcy5zZXR1cExvZ2dpbmcobG9ncywgJ0RldmljZScpO1xuICAgIHJldHVybiBsb2dzO1xuICB9XG5cbiAgc2V0dXBMb2dnaW5nIChsb2dzLCBwcmVmaXgpIHtcbiAgICBsZXQgbG9nZ2luZ1N0YXJ0ZWQgPSAhdGhpcy5yZWFsRGV2aWNlO1xuICAgIGxldCBzdGFydFRpbWUgPSBuZXcgRGF0ZSgpO1xuICAgIGZ1bmN0aW9uIHNob3VsZFN0YXJ0TG9nZ2luZyAocm93KSB7XG4gICAgICBsZXQgbG9nUm93UGFydHMgPSByb3cuc3BsaXQoL1xccysvKTtcbiAgICAgIGxldCBsb2dSb3dEYXRlID0gbmV3IERhdGUoYCR7c3RhcnRUaW1lLmdldEZ1bGxZZWFyKCl9ICR7bG9nUm93UGFydHNbMF19ICR7bG9nUm93UGFydHNbMV19ICR7bG9nUm93UGFydHNbMl19YCk7XG4gICAgICBsb2dnaW5nU3RhcnRlZCA9IGxvZ1Jvd0RhdGUuaXNBZnRlcihzdGFydFRpbWUpO1xuICAgICAgcmV0dXJuIGxvZ2dpbmdTdGFydGVkO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGlzUGVydGluZW50TG9nTGluZSAobGluZSkge1xuICAgICAgcmV0dXJuIGxpbmUubGVuZ3RoICYmXG4gICAgICAgICAgICAobGluZS5pbmRleE9mKEFHRU5UX0xPR19QUkVGSVgpICE9PSAtMSB8fFxuICAgICAgICAgICAgIGxpbmUuaW5kZXhPZihBR0VOVF9SVU5ORVJfTE9HX1BSRUZJWCkgIT09IC0xIHx8XG4gICAgICAgICAgICAgbGluZS5pbmRleE9mKFNJTV9CUklER0VfTE9HX1BSRUZJWCkgIT09IC0xKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZWFsRGV2aWNlICYmIHRoaXMucmVhbERldmljZUxvZ2dlci5pbmRleE9mKCdpZGV2aWNlc3lzbG9nJykgIT09IC0xKSB7XG4gICAgICAvLyB3ZSBhcmUgdXNpbmcgaWRldmljZXN5c2xvZywgd2hpY2ggc29tZXRpbWVzIGNhbm5vdCBjb25uZWN0IHRvIHRoZSBkZXZpY2VcbiAgICAgIC8vIGF0IHdoaWNoIHRpbWUgdGhlIHN5c3RlbSB3aWxsIG5vdCBiZSBhYmxlIHRvIGZpZ3VyZSBvdXQgdGhhdCB0aGUgcHJvY2Vzc1xuICAgICAgLy8gaGFzIHN0YXJ0ZWRcbiAgICAgIGxvZ3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgICBsZXQgZXJyb3JTdHJpbmcgPSAnQ291bGQgbm90IHN0YXJ0IGxvZ2dlciBmb3IgdWRpZCc7XG4gICAgICAgIGlmIChzdGRvdXQuaW5kZXhPZihlcnJvclN0cmluZykgIT09IC0xIHx8IHN0ZGVyci5pbmRleE9mKGVycm9yU3RyaW5nKSAhPT0gLTEpIHtcbiAgICAgICAgICAvLyB1bmZvcnR1bmF0ZWx5IHdlIGhhdmUgbm8gd2F5IHRvIHN0b3BwaW5nIHRoZSBwcm9jZXNzLCBzbyBqdXN0IGxvZyBvdmVydGx5XG4gICAgICAgICAgbGV0IG1zZyA9IGBUaGUgcmVhbCBkZXZpY2UgbG9nZ2VyICcke3RoaXMucmVhbERldmljZUxvZ2dlcn0nIHdhcyBgICtcbiAgICAgICAgICAgICAgICAgICAgYHVuYWJsZSB0byBzdGFydCBsb2cgY2FwdHVyZS4gUGxlYXNlIHRyeSBpbnN0YWxsaW5nIGAgK1xuICAgICAgICAgICAgICAgICAgICBgJ2RldmljZWNvbnNvbGUnICgnbnBtIGluc3RhbGwgLWcgZGV2aWNlY29uc29sZScpIGFuZCBgICtcbiAgICAgICAgICAgICAgICAgICAgYHNwZWNpZnkgdGhlIHBhdGggdG8gaXQgdXNpbmcgdGhlICdyZWFsRGV2aWNlTG9nZ2VyJyBjYXBhYmlsaXR5LmA7XG4gICAgICAgICAgbG9nLmVycm9yKG1zZyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5pb3NMb2dBbHJlYWR5U2hvd24pIHtcbiAgICAgIGxvZ3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgICBsZXQgb3V0ID0gc3Rkb3V0IHx8IHN0ZGVycjtcbiAgICAgICAgLy8gbWFrZSBzdXJlIHdlIGFyZSBub3QgcmVhZGluZyBsb2dzIGZyb20gYmVmb3JlIHRoaXMgdGVzdCBydW5cbiAgICAgICAgaWYgKCFsb2dnaW5nU3RhcnRlZCAmJiAhc2hvdWxkU3RhcnRMb2dnaW5nKG91dCkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGlzUGVydGluZW50TG9nTGluZShvdXQpKSB7XG4gICAgICAgICAgZm9yIChsZXQgbGluZSBvZiBvdXQuc3BsaXQoXCJcXG5cIikuZmlsdGVyKEJvb2xlYW4pKSB7XG4gICAgICAgICAgICBhZ2VudExvZy5kZWJ1ZyhgJHtwcmVmaXh9OiAke2xpbmV9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRTdGFydFRpbWUgKCkge1xuICAgIGxldCBzdGFydFRpbWUgPSBuZXcgRGF0ZSgpO1xuICAgIGlmICh0aGlzLnJlYWxEZXZpY2UpIHtcbiAgICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ2lkZXZpY2VkYXRlJywgWyctdScsIHRoaXMuZGV2aWNlLnVkaWRdKTtcbiAgICAgIHN0YXJ0VGltZSA9IG5ldyBEYXRlKHN0ZG91dCk7XG4gICAgICBpZiAoaXNOYU4oc3RhcnRUaW1lLmdldFRpbWUoKSkpIHtcbiAgICAgICAgbG9nLmRlYnVnKCdVbmFibGUgdG8gZ2V0IGRldmljZSB0aW1lLiBVc2luZyBsb2NhbCBzeXN0ZW0gdGltZScpO1xuICAgICAgICAvLyB0aGVyZSBpcyBuZXZlciBhbnkgc3RkZXJyIG91dHB1dCwganVzdCBzdGRvdXRcbiAgICAgICAgbG9nLmRlYnVnKGBPdXRwdXQgZnJvbSBpZGV2aWNlZGF0ZTogJHtzdGRvdXR9YCk7XG4gICAgICAgIHN0YXJ0VGltZSA9IG5ldyBEYXRlKCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzdGFydFRpbWU7XG4gIH1cblxuICBhc3luYyBzdGFydFhjb2RlYnVpbGQgKCkge1xuICAgIC8vIHdyYXAgdGhlIHN0YXJ0IHByb2NlZHVyZSBpbiBhIHByb21pc2Ugc28gdGhhdCB3ZSBjYW4gY2F0Y2gsIGFuZCByZXBvcnQsXG4gICAgLy8gYW55IHN0YXJ0dXAgZXJyb3JzIHRoYXQgYXJlIHRocm93biBhcyBldmVudHNcbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy54Y29kZWJ1aWxkLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgICBsb2cuaW5mbyhgeGNvZGVidWlsZCBleGl0ZWQgd2l0aCBjb2RlICcke2NvZGV9JyBhbmQgc2lnbmFsICcke3NpZ25hbH0nYCk7XG4gICAgICAgIGlmICh0aGlzLnhjb2RlYnVpbGQuX3dkYV9lcnJvcl9vY2N1cnJlZCB8fCAoIXNpZ25hbCAmJiBjb2RlICE9PSAwKSkge1xuICAgICAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKGB4Y29kZWJ1aWxkIGZhaWxlZCB3aXRoIGNvZGUgJHtjb2RlfWApKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuZGV2aWNlTG9ncy5vbignZXhpdCcsIChjb2RlKSA9PiB7XG4gICAgICAgIGxldCBtc2cgPSBgJHt0aGlzLnJlYWxEZXZpY2UgPyAnU3lzdGVtJyA6ICdTaW11bGF0b3InfSBsb2cgZXhpdGVkIHdpdGggY29kZSAnJHtjb2RlfSdgO1xuICAgICAgICBsb2cuaW5mbyhtc2cpO1xuICAgICAgICBpZiAoY29kZSkge1xuICAgICAgICAgIHJldHVybiByZWplY3QobXNnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGxldCBzdGFydFRpbWUgPSBhd2FpdCB0aGlzLmdldFN0YXJ0VGltZSgpO1xuICAgICAgICBhd2FpdCB0aGlzLnhjb2RlYnVpbGQuc3RhcnQoKTtcbiAgICAgICAgbGV0IGFnZW50VXJsID0gYXdhaXQgdGhpcy53YWl0Rm9yU3RhcnQoc3RhcnRUaW1lKTtcbiAgICAgICAgcmVzb2x2ZShhZ2VudFVybCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbGV0IG1zZyA9IGBVbmFibGUgdG8gc3RhcnQgV2ViRHJpdmVyQWdlbnQ6ICR7ZXJyfWA7XG4gICAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgICByZXR1cm4gcmVqZWN0KG1zZyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyB3YWl0Rm9yU3RhcnQgKHN0YXJ0VGltZSkge1xuICAgIC8vIHdlIGhhdmUgdG8gd2FpdCBmb3IgdGhlIHNpbSB0byBzdGFydCBiZWZvcmUgd2UgY2FuIHRhaWwgdGhlIGxvZyBmaWxlXG4gICAgaWYgKCF0aGlzLnJlYWxEZXZpY2UpIHtcbiAgICAgIGF3YWl0IHN5c3RlbUxvZ0V4aXN0cyh0aGlzLmRldmljZSk7XG4gICAgfVxuXG4gICAgbGV0IGFnZW50VXJsO1xuICAgIGxldCBsaW5lQ291bnQgPSAwO1xuICAgIGxldCBzaG93V2FpdGluZ01lc3NhZ2UgPSB0cnVlOyAvLyB0dXJuIG9mZiBsb2dnaW5nIG9uY2Ugd2UgaGF2ZSBoaXQgdGhlIGVuZFxuXG4gICAgbGV0IHN0YXJ0RGV0ZWN0b3IgPSAoc3Rkb3V0KSA9PiB7XG4gICAgICBsZXQgbWF0Y2ggPSBBR0VOVF9TVEFSVEVEX1JFR0VYLmV4ZWMoc3Rkb3V0KTtcbiAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICBpZiAodGhpcy5yZWFsRGV2aWNlKSB7XG4gICAgICAgICAgLy8gb24gYSByZWFsIGRldmljZSB0aGVyZSBtYXkgYWxyZWFkeSBiZSBzeXN0ZW0gbG9ncyB0aGF0IG5lZWQgdG8gYmVcbiAgICAgICAgICAvLyBwYXNzZWQgYmVmb3JlIHdlIGdldCB0byB0aGUgcmVhbCBzdGFydHVwIGxvZ3MsIG90aGVyd2lzZVxuICAgICAgICAgIC8vIGl0IHdpbGwgYmUgXCJkb25lXCIgYmVmb3JlIGJvb3RpbmdcbiAgICAgICAgICAvLyBFeHBlY3QgYSBsaW5lIGxpa2U6XG4gICAgICAgICAgLy8gICAgIERlYyAgNyAxMDo1NTozMiBpYW1QaG9uZSBYQ1RSdW5uZXIoV2ViRHJpdmVyQWdlbnRMaWIpWzM4Nl0gPE5vdGljZT46IFNlcnZlclVSTEhlcmUtPmh0dHA6Ly9sb2NhbGhvc3Q6ODEwMDwtU2VydmVyVVJMSGVyZVxuICAgICAgICAgIC8vIG5lZWQgdG8gZ2V0IHRoZSBkYXRlIGFuZCBhZGQgdGhlIHllYXIgZnJvbSB0aGUgc3RhcnQgZGF0ZVxuICAgICAgICAgIGxldCBkYXRlU3RyaW5nID0gYCR7c3Rkb3V0LnN1YnN0cigwLCA2KX0gJHtzdGFydFRpbWUuZ2V0RnVsbFllYXIoKX0gJHtzdGRvdXQuc3Vic3RyKDcsIDgpfWA7XG4gICAgICAgICAgbGV0IGJ1aWxkVGltZSA9IG5ldyBEYXRlKGRhdGVTdHJpbmcpO1xuICAgICAgICAgIGlmICghYnVpbGRUaW1lLmlzQWZ0ZXIoc3RhcnRUaW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGFnZW50VXJsID0gbWF0Y2hbMV07XG4gICAgICAgIGlmICghYWdlbnRVcmwpIHtcbiAgICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhuZXcgRXJyb3IoJ05vIHVybCBkZXRlY3RlZCBmcm9tIFdlYkRyaXZlckFnZW50JykpO1xuICAgICAgICB9XG4gICAgICAgIGxvZy5pbmZvKGBEZXRlY3RlZCB0aGF0IFdlYkRyaXZlckFnZW50IGlzIHJ1bm5pbmcgYXQgdXJsICcke2FnZW50VXJsfSdgKTtcbiAgICAgICAgc2hvd1dhaXRpbmdNZXNzYWdlID0gZmFsc2U7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuXG4gICAgICAvLyBwZXJpb2RpY2FsbHkgbG9nLCBzbyBpdCBkb2VzIG5vdCBsb29rIGxpa2UgZXZlcnl0aGluZyBkaWVkXG4gICAgICBsaW5lQ291bnQrKztcbiAgICAgIGxldCB0aHJlc2hvbGQgPSB0aGlzLnJlYWxEZXZpY2UgPyA1MDAwIDogMjAwO1xuICAgICAgaWYgKHNob3dXYWl0aW5nTWVzc2FnZSAmJiBsaW5lQ291bnQgJSB0aHJlc2hvbGQgPT09IDApIHtcbiAgICAgICAgbG9nLmRlYnVnKCdXYWl0aW5nIGZvciBXZWJEcml2ZXJBZ2VudCBzZXJ2ZXIgdG8gZmluaXNoIGxvYWRpbmcuLi4nKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH07XG5cbiAgICBsb2cuaW5mbygnV2FpdGluZyBmb3IgV2ViRHJpdmVyQWdlbnQgdG8gc3RhcnQgb24gZGV2aWNlJyk7XG4gICAgYXdhaXQgdGhpcy5kZXZpY2VMb2dzLnN0YXJ0KHN0YXJ0RGV0ZWN0b3IpO1xuICAgIGxvZy5pbmZvKGBXZWJEcml2ZXJBZ2VudCBzdGFydGVkIGF0IHVybCAnJHthZ2VudFVybH0nYCk7XG5cbiAgICByZXR1cm4gYWdlbnRVcmw7XG4gIH1cblxuICBhc3luYyBzdGFydGlwcm94eSAoKSB7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuaXByb3h5Lm9uKCdleGl0JywgKGNvZGUpID0+IHtcbiAgICAgICAgbG9nLndhcm4oYGlwcm94eSBleGl0ZWQgd2l0aCBjb2RlICcke2NvZGV9J2ApO1xuICAgICAgICBpZiAoY29kZSkge1xuICAgICAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKGBpcHJveHkgZXhpdGVkIHdpdGggY29kZSAnJHtjb2RlfSdgKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgdGhpcy5pcHJveHkub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgICBsZXQgb3V0ID0gc3Rkb3V0IHx8IHN0ZGVycjtcbiAgICAgICAgZm9yIChsZXQgbGluZSBvZiBvdXQuc3BsaXQoJ1xcbicpKSB7XG4gICAgICAgICAgaWYgKCFsaW5lLmxlbmd0aCkgY29udGludWU7XG4gICAgICAgICAgaXByb3h5TG9nLmRlYnVnKGxpbmUpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5pcHJveHkuc3RhcnQoNTAwMCk7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2cuZXJyb3IoYEVycm9yIHN0YXJ0aW5nIGlwcm94eTogJyR7ZXJyLm1lc3NhZ2V9J2ApO1xuICAgICAgICByZWplY3QoJ1VuYWJsZSB0byBzdGFydCBpcHJveHkuIElzIGl0IGluc3RhbGxlZD8nKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGtpbGxIYW5naW5nUHJvY2Vzc2VzICgpIHtcbiAgICBsb2cuZGVidWcoJ0tpbGxpbmcgaGFuZ2luZyBwcm9jZXNzZXMnKTtcbiAgICBhd2FpdCBraWxsQXBwVXNpbmdBcHBOYW1lKHRoaXMuZGV2aWNlLnVkaWQsIGB4Y29kZWJ1aWxkYCk7XG4gICAgbGV0IHByb2NOYW1lcyA9IHRoaXMucmVhbERldmljZSA/IFt0aGlzLnJlYWxEZXZpY2VMb2dnZXIsICdpcHJveHknXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBbJ3RhaWwnLCAnWENUUnVubmVyJ107XG4gICAgZm9yIChsZXQgcHJvYyBvZiBwcm9jTmFtZXMpIHtcbiAgICAgIGF3YWl0IGtpbGxBcHBVc2luZ0FwcE5hbWUodGhpcy5kZXZpY2UudWRpZCwgcHJvYyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcXVpdCAoKSB7XG4gICAgbG9nLmluZm8oJ1NodXR0aW5nIGRvd24gc3ViLXByb2Nlc3NlcycpO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24ga2lsbFByb2Nlc3MgKG5hbWUsIHByb2MpIHtcbiAgICAgIGlmIChwcm9jICYmIHByb2MucHJvYykge1xuICAgICAgICBsb2cuaW5mbyhgU2h1dHRpbmcgZG93biAke25hbWV9IHByb2Nlc3MgKHBpZCAke3Byb2MucHJvYy5waWR9KWApO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHByb2Muc3RvcCgnU0lHVEVSTScpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZihgUHJvY2VzcyBkaWRuJ3QgZW5kIGFmdGVyYCkgPT09IC0xKSB7XG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxvZy5kZWJ1ZyhgJHtuYW1lfSBwcm9jZXNzIGRpZCBub3QgZW5kIGluIGEgdGltZWx5IGZhc2hpb246ICcke2Vyci5tZXNzYWdlfScuIGAgK1xuICAgICAgICAgICAgICAgICAgICBgU2VuZGluZyAnU0lHS0lMTCcuLi5gKTtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgcHJvYy5zdG9wKCdTSUdLSUxMJyk7XG4gICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZignbm90IGN1cnJlbnRseSBydW5uaW5nJykgIT09IC0xKSB7XG4gICAgICAgICAgICAgIC8vIHRoZSBwcm9jZXNzIGVuZGVkIGJ1dCBmb3Igc29tZSByZWFzb24gd2Ugd2VyZSBub3QgaW5mb3JtZWRcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGF3YWl0IGtpbGxQcm9jZXNzKCd4Y29kZWJ1aWxkJywgdGhpcy54Y29kZWJ1aWxkKTtcbiAgICBhd2FpdCBraWxsUHJvY2VzcygnTG9nZ2VyJywgdGhpcy5kZXZpY2VMb2dzKTtcbiAgICBhd2FpdCBraWxsUHJvY2VzcygnaXByb3h5JywgdGhpcy5pcHJveHkpO1xuXG4gICAgaWYgKHRoaXMuandwcm94eSkge1xuICAgICAgdGhpcy5qd3Byb3h5LnNlc3Npb25JZCA9IG51bGw7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFdlYkRyaXZlckFnZW50O1xuZXhwb3J0IHsgV2ViRHJpdmVyQWdlbnQsIFdEQV9CVU5ETEVfSUQsIEJPT1RTVFJBUF9QQVRIIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
